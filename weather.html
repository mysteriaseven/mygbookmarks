<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hava Durumu Widget</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        body { background-color: transparent; font-family: 'Inter', sans-serif; }
        .weather-card { 
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0,0,0,0.05); 
            color: #0b1220; 
        }
        .weather-loader { text-align: center; padding: 40px; color: #667085; }
        #city-select, #district-select { color: white; background-color: rgba(0,0,0,0.2); }
        #city-select option, #district-select option { color: #333; background: #fff; }
    </style>
</head>
<body>

    <div class="weather-card max-w-md w-full rounded-xl shadow-xl overflow-hidden transition-all duration-300">
        <!-- Header -->
        <div class="bg-blue-500 p-4 text-white">
            <h1 class="text-xl font-bold">Hava Durumu</h1>
            <div class="flex items-center mt-2">
                <select id="city-select" class="rounded px-2 py-1 mr-2 border border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-300 w-1/2">
                    <!-- Sadece Ankara yüklenecek -->
                </select>
                <select id="district-select" class="rounded px-2 py-1 border border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-300 w-1/2">
                    <option value="">İlçe seçin</option>
                </select>
            </div>
        </div>
        <!-- Hava Durumu İçeriği -->
        <div id="weather-body">
            <div class="weather-loader">Yükleniyor...</div>
        </div>
    </div>

    <script>
        // SADECE ANKARA VERİSİ BURAYA GÖMÜLDÜ
        const provincesData = [
            {"id":6,"name":"Ankara","latitude":"39.9208","longitude":"32.8541","population":5782285,"region":"İç Anadolu","districts":[{"id":69,"name":"Akyurt","latitude":"40.1294","longitude":"33.0878","population":40700},{"id":70,"name":"Altındağ","latitude":"39.94 Altındağ","longitude":"32.85","population":413994},{"id":71,"name":"Ayaş","latitude":"40.0167","longitude":"32.3333","population":12711},{"id":72,"name":"Bala","latitude":"39.4667","longitude":"33.1333","population":23287},{"id":73,"name":"Beypazarı","latitude":"40.1667","longitude":"31.9167","population":48469},{"id":74,"name":"Çamlıdere","latitude":"40.4833","longitude":"32.4833","population":8273},{"id":75,"name":"Çankaya","latitude":"39.9208","longitude":"32.8541","population":942553},{"id":76,"name":"Çubuk","latitude":"40.2333","longitude":"33.0167","population":91142},{"id":77,"name":"Elmadağ","latitude":"39.9167","longitude":"33.2","population":44354},{"id":78,"name":"Etimesgut","latitude":"39.95","longitude":"32.6833","population":614890},{"id":79,"name":"Evren","latitude":"39.0833","longitude":"33.7833","population":2763},{"id":80,"name":"Gölbaşı","latitude":"39.75","longitude":"32.8","population":150596},{"id":81,"name":"Güdül","latitude":"40.2167","longitude":"32.25","population":8019},{"id":82,"name":"Haymana","latitude":"39.45","longitude":"32.5","population":26323},{"id":83,"name":"Kahramankazan","latitude":"40.2167","longitude":"32.6833","population":59123},{"id":84,"name":"Kalecik","latitude":"40.0917","longitude":"33.3917","population":12439},{"id":85,"name":"Keçiören","latitude":"39.9667","longitude":"32.8667","population":942884},{"id":86,"name":"Kızılcahamam","latitude":"40.4667","longitude":"32.65","population":27484},{"id":87,"name":"Mamak","latitude":"39.9333","longitude":"32.9333","population":687527},{"id":88,"name":"Nallıhan","latitude":"40.15","longitude":"31.6","population":26778},{"id":89,"name":"Polatlı","latitude":"39.5833","longitude":"32.15","population":128378},{"id":90,"name":"Pursaklar","latitude":"40.0536","longitude":"32.9158","population":162483},{"id":91,"name":"Sincan","latitude":"39.9667","longitude":"32.5833","population":572609},{"id":92,"name":"Şereflikoçhisar","latitude":"39.05","longitude":"33.5333","population":33475},{"id":93,"name":"Yenimahalle","latitude":"39.95","longitude":"32.8","population":713171}]}
        ];
    </script>

    <script>
        // ANA UYGULAMA MANTIĞI
        const citySelect = document.getElementById('city-select');
        const districtSelect = document.getElementById('district-select');
        const weatherBody = document.getElementById('weather-body');

        function getWeatherInfo(code, isDay = true) {
            const info = { description: "Açık", icon: isDay ? "sun" : "moon" };
            if ([0, 1].includes(code)) { info.description = "Açık"; info.icon = isDay ? "sun" : "moon"; }
            else if ([2].includes(code)) { info.description = "Parçalı Bulutlu"; info.icon = "cloud"; }
            else if ([3].includes(code)) { info.description = "Kapalı"; info.icon = "cloud"; }
            else if ([45, 48].includes(code)) { info.description = "Sisli"; info.icon = "align-justify"; }
            else if ([51, 53, 55, 56, 57].includes(code)) { info.description = "Çiseleme"; info.icon = "cloud-drizzle"; }
            else if ([61, 63, 65, 66, 67].includes(code)) { info.description = "Yağmurlu"; info.icon = "cloud-rain"; }
            else if ([71, 73, 75, 77, 85, 86].includes(code)) { info.description = "Karlı"; info.icon = "cloud-snow"; }
            else if ([80, 81, 82].includes(code)) { info.description = "Sağanak Yağışlı"; info.icon = "cloud-lightning"; }
            else if ([95, 96, 99].includes(code)) { info.description = "Fırtınalı"; info.icon = "wind"; }
            return info;
        }

        function updateWeatherUI(data) {
            const now = new Date();
            const currentInfo = getWeatherInfo(data.current.weather_code, data.current.is_day);

            weatherBody.innerHTML = `
                <div class="p-4 border-b border-gray-200"><div class="flex justify-between items-center"><div><h2 class="text-2xl font-semibold">Şu An</h2><p class="text-gray-600">${now.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' })}</p></div><div class="text-right"><div class="flex items-center justify-end"><i data-feather="${currentInfo.icon}" class="w-12 h-12 text-yellow-500"></i><span class="text-3xl font-bold ml-2">${Math.round(data.current.temperature_2m)}°</span></div><p class="text-gray-600">${currentInfo.description}</p></div></div></div>
                <div class="p-4 border-b border-gray-200"><h3 class="text-lg font-medium mb-3">Saatlik Tahmin</h3><div class="flex overflow-x-auto space-x-4 pb-2" id="hourly-forecast-items"></div></div>
                <div class="p-4"><h3 class="text-lg font-medium mb-3">5 Günlük Tahmin</h3><div class="space-y-3" id="daily-forecast-items"></div></div>`;

            const hourlyContainer = document.getElementById('hourly-forecast-items');
            data.hourly.time.map((t, i) => ({ time: new Date(t), temp: data.hourly.temperature_2m[i], code: data.hourly.weather_code[i] })).filter(h => h.time >= now).slice(0, 6).forEach(h => {
                const hourInfo = getWeatherInfo(h.code);
                hourlyContainer.innerHTML += `<div class="text-center flex-shrink-0"><p class="text-sm font-medium">${h.time.getHours()}:00</p><i data-feather="${hourInfo.icon}" class="w-6 h-6 my-1 text-yellow-500 mx-auto"></i><p>${Math.round(h.temp)}°</p></div>`;
            });

            const dailyContainer = document.getElementById('daily-forecast-items');
            data.daily.time.map((t, i) => ({ time: new Date(t), max: data.daily.temperature_2m_max[i], min: data.daily.temperature_2m_min[i], code: data.daily.weather_code[i] })).slice(1, 6).forEach(d => {
                const dayInfo = getWeatherInfo(d.code);
                dailyContainer.innerHTML += `<div class="flex items-center justify-between p-2 rounded-lg bg-gray-50"><p class="font-medium w-24">${d.time.toLocaleDateString('tr-TR', { weekday: 'long' })}</p><div class="flex items-center"><i data-feather="${dayInfo.icon}" class="w-5 h-5 mr-2 text-yellow-500"></i><span class="text-gray-600 mr-3 w-8 text-right">${Math.round(d.min)}°</span><span class="font-medium w-8 text-right">${Math.round(d.max)}°</span></div></div>`;
            });
            feather.replace();
        }
        
        async function fetchWeather(lat, lon) {
            weatherBody.innerHTML = '<div class="weather-loader">Hava durumu verisi alınıyor...</div>';
            try {
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,is_day,weather_code&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Europe/Istanbul`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                updateWeatherUI(data);
            } catch (error) {
                console.error("Hava durumu verisi alınırken hata oluştu:", error);
                weatherBody.innerHTML = '<div class="weather-loader text-red-500">Bir hata oluştu. Lütfen internet bağlantınızı kontrol edin.</div>';
            }
        }

        citySelect.addEventListener('change', function() {
            districtSelect.innerHTML = '<option value="">İlçe seçin</option>';
            districtSelect.disabled = true;
            if (this.value) {
                const province = provincesData.find(p => p.name === this.value);
                if (province && province.districts) {
                    province.districts.forEach(d => { districtSelect.innerHTML += `<option value="${d.name}">${d.name}</option>`; });
                    districtSelect.disabled = false;
                }
            }
        });

        districtSelect.addEventListener('change', function() {
            if (citySelect.value && this.value) {
                const p = provincesData.find(p => p.name === citySelect.value);
                const d = p ? p.districts.find(d => d.name === this.value) : null;
                if (d) {
                    fetchWeather(d.latitude, d.longitude);
                }
            }
        });

        function initializeWeatherWidget() {
            try {
                // İl listesini sadece Ankara ile doldur
                const ankara = provincesData[0];
                citySelect.innerHTML = `<option value="${ankara.name}">${ankara.name}</option>`;
                
                // Varsayılan olarak Ankara / Etimesgut seçili gelsin
                citySelect.value = 'Ankara';
                citySelect.dispatchEvent(new Event('change')); 
                
                districtSelect.value = 'Etimesgut';
                districtSelect.dispatchEvent(new Event('change'));

            } catch (error) {
                console.error("Widget başlatılırken hata:", error);
                weatherBody.innerHTML = '<div class="weather-loader text-red-500">Bilinmeyen bir hata oluştu.</div>';
            }
        }
        
        initializeWeatherWidget();
    </script>
</body>
</html>
