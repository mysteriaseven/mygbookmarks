<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hava Durumu Widget</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        /* Ana sayfanın arka planıyla uyumlu olması için */
        body { background-color: transparent; font-family: 'Inter', sans-serif; }
        
        .weather-card { 
            backdrop-filter: blur(10px); 
            background-color: rgba(255, 255, 255, 0.9); /* Ana uygulamadaki kart rengi */
            border: 1px solid rgba(0,0,0,0.05); 
            color: #0b1220; 
        }
        .weather-loader { text-align: center; padding: 40px; color: #667085; }
        #city-select, #district-select { color: white; background-color: rgba(0,0,0,0.2); }
        #city-select option, #district-select option { color: #333; background: #fff; }
    </style>
</head>
<body>

    <div class="weather-card max-w-md w-full rounded-xl shadow-xl overflow-hidden transition-all duration-300">
        <!-- Header -->
        <div class="bg-blue-500 p-4 text-white">
            <h1 class="text-xl font-bold">Gökyüzü Gözcüsü</h1>
            <div class="flex items-center mt-2">
                <select id="city-select" class="rounded px-2 py-1 mr-2 border border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-300 w-1/2">
                    <option value="">İl Yükleniyor...</option>
                </select>
                <select id="district-select" class="rounded px-2 py-1 border border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-300 w-1/2" disabled>
                    <option value="">Önce il seçin</option>
                </select>
            </div>
        </div>
        <!-- Hava Durumu İçeriği -->
        <div id="weather-body">
            <div class="weather-loader">Yükleniyor...</div>
        </div>
    </div>

    <script>
        const citySelect = document.getElementById('city-select');
        const districtSelect = document.getElementById('district-select');
        const weatherBody = document.getElementById('weather-body');
        
        const CITIES_DATA_URL = 'https://raw.githubusercontent.com/ahmet-cetinkaya/turkey-cities/master/cities_of_turkey.json';
        let provincesData = [];

        function getWeatherInfo(code, isDay = true) {
            const info = { description: "Açık", icon: isDay ? "sun" : "moon" };
            if ([0, 1].includes(code)) { info.description = "Açık"; info.icon = isDay ? "sun" : "moon"; }
            else if ([2].includes(code)) { info.description = "Parçalı Bulutlu"; info.icon = "cloud"; }
            else if ([3].includes(code)) { info.description = "Kapalı"; info.icon = "cloud"; }
            else if ([45, 48].includes(code)) { info.description = "Sisli"; info.icon = "align-justify"; }
            else if ([51, 53, 55, 56, 57].includes(code)) { info.description = "Çiseleme"; info.icon = "cloud-drizzle"; }
            else if ([61, 63, 65, 66, 67].includes(code)) { info.description = "Yağmurlu"; info.icon = "cloud-rain"; }
            else if ([71, 73, 75, 77, 85, 86].includes(code)) { info.description = "Karlı"; info.icon = "cloud-snow"; }
            else if ([80, 81, 82].includes(code)) { info.description = "Sağanak Yağışlı"; info.icon = "cloud-lightning"; }
            else if ([95, 96, 99].includes(code)) { info.description = "Fırtınalı"; info.icon = "wind"; }
            return info;
        }

        function updateWeatherUI(data) {
            const now = new Date();
            const currentInfo = getWeatherInfo(data.current.weather_code, data.current.is_day);

            weatherBody.innerHTML = `
                <div class="p-4 border-b border-gray-200"><div class="flex justify-between items-center"><div><h2 class="text-2xl font-semibold">Şu An</h2><p class="text-gray-600">${now.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' })}</p></div><div class="text-right"><div class="flex items-center justify-end"><i data-feather="${currentInfo.icon}" class="w-12 h-12 text-yellow-500"></i><span class="text-3xl font-bold ml-2">${Math.round(data.current.temperature_2m)}°</span></div><p class="text-gray-600">${currentInfo.description}</p></div></div></div>
                <div class="p-4 border-b border-gray-200"><h3 class="text-lg font-medium mb-3">Saatlik Tahmin</h3><div class="flex overflow-x-auto space-x-4 pb-2" id="hourly-forecast-items"></div></div>
                <div class="p-4"><h3 class="text-lg font-medium mb-3">5 Günlük Tahmin</h3><div class="space-y-3" id="daily-forecast-items"></div></div>`;

            const hourlyContainer = document.getElementById('hourly-forecast-items');
            data.hourly.time.map((t, i) => ({ time: new Date(t), temp: data.hourly.temperature_2m[i], code: data.hourly.weather_code[i] })).filter(h => h.time >= now).slice(0, 6).forEach(h => {
                const hourInfo = getWeatherInfo(h.code);
                hourlyContainer.innerHTML += `<div class="text-center flex-shrink-0"><p class="text-sm font-medium">${h.time.getHours()}:00</p><i data-feather="${hourInfo.icon}" class="w-6 h-6 my-1 text-yellow-500 mx-auto"></i><p>${Math.round(h.temp)}°</p></div>`;
            });

            const dailyContainer = document.getElementById('daily-forecast-items');
            data.daily.time.map((t, i) => ({ time: new Date(t), max: data.daily.temperature_2m_max[i], min: data.daily.temperature_2m_min[i], code: data.daily.weather_code[i] })).slice(1, 6).forEach(d => {
                const dayInfo = getWeatherInfo(d.code);
                dailyContainer.innerHTML += `<div class="flex items-center justify-between p-2 rounded-lg bg-gray-50"><p class="font-medium w-24">${d.time.toLocaleDateString('tr-TR', { weekday: 'long' })}</p><div class="flex items-center"><i data-feather="${dayInfo.icon}" class="w-5 h-5 mr-2 text-yellow-500"></i><span class="text-gray-600 mr-3 w-8 text-right">${Math.round(d.min)}°</span><span class="font-medium w-8 text-right">${Math.round(d.max)}°</span></div></div>`;
            });
            if (typeof feather !== 'undefined') feather.replace();
        }
        
        async function fetchWeather(lat, lon) {
            weatherBody.innerHTML = '<div class="weather-loader">Hava durumu verisi alınıyor...</div>';
            try {
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,is_day,weather_code&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Europe/Istanbul`);
                if (!response.ok) throw new Error('Hava durumu verisi alınamadı.');
                updateWeatherUI(await response.json());
            } catch (error) {
                weatherBody.innerHTML = '<div class="weather-loader text-red-500">Bir hata oluştu.</div>';
            }
        }

        citySelect.addEventListener('change', function() {
            districtSelect.innerHTML = '<option value="">İlçe seçin</option>';
            districtSelect.disabled = true;
            if (this.value) {
                const province = provincesData.find(p => p.name === this.value);
                if (province) {
                    province.districts.forEach(d => { districtSelect.innerHTML += `<option value="${d.name}">${d.name}</option>`; });
                    districtSelect.disabled = false;
                }
            }
        });

        districtSelect.addEventListener('change', function() {
            if (citySelect.value && this.value) {
                const p = provincesData.find(p => p.name === citySelect.value);
                const d = p.districts.find(d => d.name === this.value);
                if (d) fetchWeather(d.latitude, d.longitude);
            }
        });

        async function initializeWeatherWidget() {
            try {
                const response = await fetch(CITIES_DATA_URL);
                provincesData = await response.json();
                citySelect.innerHTML = '<option value="">İl seçin</option>';
                provincesData.forEach(p => { citySelect.innerHTML += `<option value="${p.name}">${p.name}</option>`; });
                citySelect.value = 'İstanbul';
                citySelect.dispatchEvent(new Event('change'));
                districtSelect.value = 'Kadıköy';
                districtSelect.dispatchEvent(new Event('change'));
            } catch (error) {
                weatherBody.innerHTML = '<div class="weather-loader text-red-500">Widget yüklenemedi.</div>';
                citySelect.innerHTML = '<option value="">Hata!</option>';
            }
        }
        
        // Başlat
        initializeWeatherWidget();
    </script>
</body>
</html>



