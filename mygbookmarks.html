<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>My Bookmarks</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f6faff;
  --card:#fff;
  --muted:#667085;
  --accent:#00a3ff;
  font-family:'Inter',sans-serif;
}
html,body{margin:0;height:100%;background:var(--bg);color:#0b1220;}
.app{display:grid;grid-template-columns:280px 1fr;height:100vh;}
.sidebar{
  background:linear-gradient(180deg,#ffffff,rgba(255,255,255,0.9));
  border-right:1px solid rgba(0,0,0,0.05);
  padding:20px;
  display:flex;flex-direction:column;gap:16px;
}
.brand{display:flex;align-items:center;gap:12px;}
.logo{
  width:48px;height:48px;border-radius:50%;
  background:conic-gradient(from 180deg,#00a3ff,#00ffd0,#f0ff00,#ff7c7c,#00a3ff);
  display:flex;align-items:center;justify-content:center;
  font-weight:800;color:#022;overflow:hidden;
}
.logo img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
h1{font-size:17px;margin:0;}
.categories{flex:1;overflow:auto;padding-top:6px; display:flex; flex-direction:column; gap:4px;}
.category{
  display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;
  cursor:pointer;user-select:none;transition: background .2s, opacity .2s;
  position:relative;
}
.category.dragging{ opacity: 0.5; background: rgba(0,163,255,0.2); }
.category:hover{background:rgba(0,163,255,0.08);}
.category.active{background:rgba(0,163,255,0.12);}
.cat-icon{width:36px;height:36px;border-radius:8px;
  background:linear-gradient(180deg,#fff,#f3faff);
  display:flex;align-items:center;justify-content:center;font-weight:700;}
.cat-name{font-weight:600;flex:1;pointer-events: none;}
.main{
  display:flex;flex-direction:column;height:100%;overflow:hidden;
  background:linear-gradient(180deg,#ffffff,#f9fcff);
  padding:24px;
}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.header-title{font-size:20px;font-weight:800;}
.bookmark-list{flex:1;overflow:auto;display:flex;flex-direction:column;gap:10px;}
.card{
  display:flex;align-items:center;gap:12px;background:var(--card);
  padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,0.05);
  cursor:grab;transition:transform .1s;
}
.card:active{transform:scale(0.98);}
.card .fav{width:46px;height:46px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700; overflow:hidden;}
.card .meta{flex:1;min-width:0;}
.card .meta .title{font-weight:700;}
.card .meta .url{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.card .actions{display:flex;gap:6px;}
.icon-btn{width:32px;height:32px;border-radius:8px;display:grid;place-items:center;
  border:1px solid rgba(0,0,0,0.05);cursor:pointer; background: #fff;}
.icon-btn:hover{background:#f0f0f0;}
.delete-cat{ display:none; }
.category:hover .delete-cat{ display:grid; }
/* Home widget */
.home-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:18px; }
.home-tile{
  background:var(--card);border-radius:16px;padding:16px;text-align:center;
  box-shadow:0 6px 16px rgba(0,0,0,0.04);
  transition:transform .2s;cursor:pointer;
}
.home-tile:hover{transform:translateY(-3px);}
.home-tile img{width:48px;height:48px;border-radius:12px;margin-bottom:8px; object-fit:cover;}
.home-tile .title{font-weight:600;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%;}
/* Modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(8,15,28,0.35);z-index:100;}
.modal.active{display:flex;}
.modal-card{ width:400px;background:var(--card);padding:20px;border-radius:14px; box-shadow:0 20px 40px rgba(0,0,0,0.15); }
label{font-size:13px;color:var(--muted);display:block;margin-top:10px;}
input[type=text], textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.1);box-sizing:border-box; margin-top:4px;}
textarea{min-height:70px;}
.modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px;}
.btn{padding:8px 12px;border-radius:10px;background:#f4f7fa;border:1px solid rgba(0,0,0,0.05);cursor:pointer;}
.btn:hover{background:#e8eef3;}
.switch{display:flex;align-items:center;gap:8px;margin-top:12px; user-select:none;}
.user-info{font-size:13px;color:var(--muted);}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="logo" id="userLogo">Y</div>
      <div>
        <h1 id="sidebarTitle">My Bookmarks</h1>
        <div id="sidebarSubtitle" style="font-size:12px;color:var(--muted)">Bookmarks</div>
      </div>
    </div>
    <div class="user-info" id="userInfo"></div>
    <button class="btn" id="loginBtn">Sign in with Google</button>
    <button class="btn" id="logoutBtn" style="display:none;">Sign Out</button>
    <hr style="border:none; border-top:1px solid #eee; margin: 8px 0;">
    <button class="btn" id="homeBtn">üè† Home</button>
    <button class="btn" id="addCategoryBtn" style="display:none;">+ Add Category</button>
    <div class="categories" id="categories"></div>
  </aside>

  <main class="main" id="main">
    <div class="header"> <div class="header-title" id="pageTitle">Home</div> </div>
    <div id="contentArea"></div>
  </main>
</div>

<!-- MODALS -->
<div class="modal" id="modal">
  <div class="modal-card">
    <h3 id="modalTitle">Add/Edit</h3>
    <label for="mTitle">Title</label><input id="mTitle" type="text">
    <label for="mUrl">URL</label><input id="mUrl" type="text">
    <label for="mIcon">Icon URL (optional)</label><input id="mIcon" type="text">
    <div class="switch"><input type="checkbox" id="mShowHome"><label for="mShowHome">Show on Home</label></div>
    <div class="modal-actions">
      <button class="btn" id="cancelModal">Cancel</button>
      <button class="btn" id="saveModal">Save</button>
    </div>
  </div>
</div>

<div class="modal" id="modalCategory">
  <div class="modal-card">
    <h3>Add Category</h3>
    <label for="cTitle">Category Name</label><input id="cTitle" type="text">
    <div class="modal-actions">
      <button class="btn" id="cancelCategory">Cancel</button>
      <button class="btn" id="saveCategory">Save</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBZ5oi1Vb-cNFQIk04rKMDwLJWVx06DfmI", // L√ºtfen kendi Firebase config bilgilerinizle deƒüi≈ütirin
    authDomain: "my-g-bookmarks.firebaseapp.com",
    projectId: "my-g-bookmarks",
    storageBucket: "my-g-bookmarks.firebasestorage.app",
    messagingSenderId: "702837130313",
    appId: "1:702837130313:web:bb7e64d33a772ed3d1eb98",
    measurementId: "G-WZVPMS2XY4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();

let BOOKMARKS = [];
let currentUser = null;
let currentCategoryId = null; // Currently viewed category
let editingId = null; // ID of the bookmark being edited
let editingMode = null; // 'add' or 'edit'

const $ = (selector) => document.querySelector(selector);
const $$ = (selector) => document.querySelectorAll(selector);

// --- AUTH ---
$('#loginBtn').onclick = async () => {
  const provider = new GoogleAuthProvider();
  try { await signInWithPopup(auth, provider); }
  catch(e) { console.error("Sign in error: ", e); }
};
$('#logoutBtn').onclick = async () => { await signOut(auth); };

onAuthStateChanged(auth, async user => {
  currentUser = user;
  if (user) {
    $('#userInfo').textContent = user.email;
    $('#sidebarTitle').textContent = user.displayName || 'Bookmarks';
    $('#sidebarSubtitle').textContent = 'Bookmarks';
    if (user.photoURL) { $('#userLogo').innerHTML = `<img src="${user.photoURL}" alt="User avatar">`; }
    else { $('#userLogo').textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : 'U'; }
    $('#loginBtn').style.display = 'none';
    $('#logoutBtn').style.display = 'block';
    $('#addCategoryBtn').style.display = 'block';
    await loadBookmarks();
  } else {
    $('#userInfo').textContent = '';
    $('#sidebarTitle').textContent = 'My Bookmarks';
    $('#sidebarSubtitle').textContent = 'Bookmarks';
    $('#userLogo').textContent = 'Y';
    $('#loginBtn').style.display = 'block';
    $('#logoutBtn').style.display = 'none';
    $('#addCategoryBtn').style.display = 'none';
    BOOKMARKS = [];
    currentCategoryId = null;
    renderCategories();
    $('#contentArea').innerHTML = "<div style='padding:20px; color:var(--muted)'>Please sign in to manage your bookmarks.</div>";
    $('#pageTitle').textContent = 'Welcome';
  }
});

// --- DATA ---
async function loadBookmarks() {
  if (!currentUser) return;
  const snap = await getDoc(doc(db, "bookmarks", currentUser.uid));
  BOOKMARKS = snap.exists() ? snap.data().categories || [] : [];
  renderCategories();
  renderHome();
}

async function saveBookmarks() {
  if (!currentUser) return;
  await setDoc(doc(db, "bookmarks", currentUser.uid), { categories: BOOKMARKS });
}

// --- RENDER ---
function renderCategories() {
  const categoriesEl = $('#categories');
  categoriesEl.innerHTML = '';
  BOOKMARKS.forEach(cat => {
    const el = document.createElement('div');
    el.className = 'category' + (cat.id === currentCategoryId ? ' active' : '');
    el.dataset.id = cat.id;
    el.draggable = true;

    el.innerHTML = `
      <div class="cat-icon">${cat.title.charAt(0).toUpperCase()}</div>
      <div class="cat-name">${cat.title}</div>
      <div class="icon-btn delete-cat">üóëÔ∏è</div>
    `;
    
    // ATTACH LISTENERS
    el.onclick = () => {
        currentCategoryId = cat.id;
        renderCategories(); // Update active state
        renderCategory(cat.id);
    };
    el.querySelector('.delete-cat').onclick = (e) => {
        e.stopPropagation();
        deleteCategory(cat.id);
    };
    
    // DRAG & DROP FOR CATEGORY SORTING
    el.addEventListener('dragstart', (e) => {
        e.stopPropagation();
        e.dataTransfer.setData('text/category-id', cat.id);
        setTimeout(() => el.classList.add('dragging'), 0);
    });
    el.addEventListener('dragend', (e) => el.classList.remove('dragging'));

    el.addEventListener('dragover', (e) => e.preventDefault());

    el.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        el.classList.remove('dragging');
        
        const droppedBookmarkId = e.dataTransfer.getData('text/bookmark-id');
        const draggedCategoryId = e.dataTransfer.getData('text/category-id');

        if(draggedCategoryId) { // A category is being dropped on another category
            moveCategory(draggedCategoryId, cat.id);
        } else if (droppedBookmarkId) { // A bookmark is being dropped on a category
            moveBookmark(droppedBookmarkId, cat.id);
        }
    });

    categoriesEl.appendChild(el);
  });
}

function renderHome() {
  currentCategoryId = null;
  $('#pageTitle').textContent = 'Home';
  renderCategories(); // To remove active state

  const homeItems = BOOKMARKS.flatMap(c => c.items.filter(i => i.showHome));
  
  if (homeItems.length === 0) {
    $('#contentArea').innerHTML = "<div style='padding:20px; color:var(--muted)'>No bookmarks on Home.</div>";
    return;
  }
  
  const grid = document.createElement('div');
  grid.className = 'home-grid';
  homeItems.forEach(item => {
    const tile = document.createElement('div');
    tile.className = 'home-tile';
    tile.onclick = () => window.open(item.url, '_blank');
    const iconSrc = item.icon || `https://www.google.com/s2/favicons?domain=${new URL(item.url).hostname}&sz=64`;
    tile.innerHTML = `<img src="${iconSrc}" alt="Favicon" onerror="this.src='https://www.google.com/s2/favicons?domain=google.com&sz=64'"><div class='title'>${item.title}</div>`;
    grid.appendChild(tile);
  });
  $('#contentArea').innerHTML = '';
  $('#contentArea').appendChild(grid);
}

function renderCategory(catId) {
  const cat = BOOKMARKS.find(c => c.id === catId);
  if (!cat) { renderHome(); return; }

  $('#pageTitle').textContent = cat.title;
  const contentArea = $('#contentArea');
  contentArea.innerHTML = '';

  const list = document.createElement('div');
  list.className = 'bookmark-list';
  
  cat.items.forEach(item => {
    const card = document.createElement('div');
    card.className = 'card';
    card.draggable = true;
    card.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/bookmark-id', item.id); });

    const iconHtml = item.icon 
      ? `<img src="${item.icon}" style="width:100%; height:100%; border-radius:inherit; object-fit:cover;" onerror="this.parentElement.innerHTML = '${item.title.charAt(0).toUpperCase()}'">` 
      : item.title.charAt(0).toUpperCase();

    card.innerHTML = `
      <div class="fav" style="background:${cat.color || '#00a3ff'};">${iconHtml}</div>
      <div class="meta">
        <div class="title">${item.title}</div>
        <div class="url">${item.url}</div>
      </div>
      <div class="actions">
        <button class="icon-btn edit-btn" data-id="${item.id}">‚úèÔ∏è</button>
        <button class="icon-btn delete-btn" data-id="${item.id}">üóëÔ∏è</button>
      </div>
    `;
    list.appendChild(card);
  });
  contentArea.appendChild(list);

  list.querySelectorAll('.edit-btn').forEach(btn => btn.onclick = () => openModalForEdit(btn.dataset.id));
  list.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = () => deleteBookmark(btn.dataset.id));

  const addBtn = document.createElement('button');
  addBtn.textContent = '+ Add Bookmark';
  addBtn.className = 'btn';
  addBtn.style.marginTop = '20px';
  addBtn.onclick = () => openModalForAdd();
  contentArea.appendChild(addBtn);
}

// --- MODAL & ACTIONS ---
function openModalForAdd() {
    if (!currentCategoryId) {
        alert("Please select a category first.");
        return;
    }
    editingId = null;
    editingMode = "add";
    $('#modalTitle').textContent = "Add Bookmark";
    $('#mTitle').value = ''; $('#mUrl').value = ''; $('#mIcon').value = ''; $('#mShowHome').checked = false;
    $('#modal').classList.add('active');
}

function openModalForEdit(id) {
  const cat = BOOKMARKS.find(c => c.items.some(i => i.id === id));
  if (!cat) return;
  const item = cat.items.find(i => i.id === id);
  
  editingId = id;
  editingMode = 'edit';
  
  $('#mTitle').value = item.title;
  $('#mUrl').value = item.url;
  $('#mIcon').value = item.icon || '';
  $('#mShowHome').checked = item.showHome || false;
  
  $('#modalTitle').textContent = "Edit Bookmark";
  $('#modal').classList.add('active');
}

$('#saveModal').onclick = async () => {
  const title = $('#mTitle').value.trim();
  const url = $('#mUrl').value.trim();
  if (!title || !url) { alert("Title and URL are required."); return; }

  const bookmarkData = { 
      title, 
      url, 
      icon: $('#mIcon').value.trim(), 
      showHome: $('#mShowHome').checked 
  };

  if (editingMode === 'add') {
    const cat = BOOKMARKS.find(c => c.id === currentCategoryId);
    if (cat) {
      cat.items.push({ id: 'b_' + Date.now(), ...bookmarkData });
    }
  } else if (editingMode === 'edit') {
    const cat = BOOKMARKS.find(c => c.items.some(i => i.id === editingId));
    if (cat) {
        const itemIndex = cat.items.findIndex(i => i.id === editingId);
        if (itemIndex > -1) {
            const originalId = cat.items[itemIndex].id;
            cat.items[itemIndex] = { id: originalId, ...bookmarkData };
        }
    }
  }
  
  $('#modal').classList.remove('active');
  await saveBookmarks();
  
  if (currentCategoryId) { renderCategory(currentCategoryId); } 
  renderHome();
};

async function deleteBookmark(id) {
  if (!confirm("Are you sure you want to delete this bookmark?")) return;
  const cat = BOOKMARKS.find(c => c.items.some(i => i.id === id));
  if (cat) {
      cat.items = cat.items.filter(i => i.id !== id);
      await saveBookmarks();
      if(currentCategoryId) { renderCategory(cat.id); }
      renderHome();
  }
};

// --- CATEGORY ACTIONS ---
$('#addCategoryBtn').onclick = () => { $('#cTitle').value = ''; $('#modalCategory').classList.add('active'); };
$('#cancelCategory').onclick = () => $('#modalCategory').classList.remove('active');
$('#saveCategory').onclick = async () => {
  const title = $('#cTitle').value.trim();
  if (!title) return;
  BOOKMARKS.unshift({ id: 'cat_' + Date.now(), title, color: `#${Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')}`, items: [] });
  await saveBookmarks();
  $('#modalCategory').classList.remove('active');
  renderCategories();
};

async function deleteCategory(catId) {
    if (!confirm("Are you sure? Bookmarks inside will be moved to 'Diƒüer' category.")) return;
    
    let catToDelete = BOOKMARKS.find(c => c.id === catId);
    if (!catToDelete) return;

    let otherCat = BOOKMARKS.find(c => c.title === 'Diƒüer');
    if (!otherCat) { // Create 'Diƒüer' if it doesn't exist
        otherCat = { id: 'cat_other_' + Date.now(), title: 'Diƒüer', color: '#808080', items: [] };
        BOOKMARKS.push(otherCat);
    }
    
    // Move bookmarks
    if(catToDelete.items.length > 0) {
        otherCat.items.push(...catToDelete.items);
    }

    // Delete the category
    BOOKMARKS = BOOKMARKS.filter(c => c.id !== catId);
    
    await saveBookmarks();
    
    if (currentCategoryId === catId) { renderHome(); } 
    else { renderCategories(); }
}

// --- DRAG & DROP ---
async function moveBookmark(bId, targetCatId) {
  let sourceCat = BOOKMARKS.find(c => c.items.some(i => i.id === bId));
  if (!sourceCat || sourceCat.id === targetCatId) return;

  const bookmark = sourceCat.items.find(i => i.id === bId);
  sourceCat.items = sourceCat.items.filter(i => i.id !== bId);
  
  const targetCat = BOOKMARKS.find(c => c.id === targetCatId);
  targetCat.items.push(bookmark);
  
  await saveBookmarks();
  if(currentCategoryId) { renderCategory(currentCategoryId); }
}

async function moveCategory(draggedId, targetId) {
    const draggedIndex = BOOKMARKS.findIndex(c => c.id === draggedId);
    const targetIndex = BOOKMARKS.findIndex(c => c.id === targetId);
    if (draggedIndex === -1 || targetIndex === -1) return;

    const [draggedItem] = BOOKMARKS.splice(draggedIndex, 1);
    BOOKMARKS.splice(targetIndex, 0, draggedItem);
    
    await saveBookmarks();
    renderCategories();
}


// --- NAVIGATION & GENERAL ---
$('#homeBtn').onclick = renderHome;
$('#cancelModal').onclick = () => $('#modal').classList.remove('active');
document.addEventListener('keydown', e => { if (e.key === 'Escape') { $$('.modal').forEach(m => m.classList.remove('active')); }});
</script>
</body>
</html>
