<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>My Bookmarks v1.9</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{ --bg:#f6faff; --card:#fff; --muted:#667085; --accent:#00a3ff; font-family:'Inter',sans-serif; }
html,body{margin:0;height:100%;background:var(--bg);color:#0b1220;}
.app{display:grid;grid-template-columns:280px 1fr;height:100vh;}
.sidebar{ background:linear-gradient(180deg,#ffffff,rgba(255,255,255,0.9)); border-right:1px solid rgba(0,0,0,0.05); padding:20px; display:flex;flex-direction:column;gap:16px; }
#versionInfo {
    background: #eef7ff; color: #007acc; padding: 3px 8px;
    border-radius: 8px; font-size: 12px; font-weight: 600;
    align-self: flex-start; /* Aligns item to the start of the flex container */
    margin-bottom: 8px; /* Adds space below the version tag */
}
.brand{display:flex;align-items:center;gap:12px;}
.logo{ width:48px;height:48px;border-radius:50%; background:conic-gradient(from 180deg,#00a3ff,#00ffd0,#f0ff00,#ff7c7c,#00a3ff); display:flex;align-items:center;justify-content:center; font-weight:800;color:#022;overflow:hidden; }
.logo img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
h1{font-size:17px;margin:0;}
#sidebarSubtitleContainer{ display: flex; align-items: center; justify-content: space-between; font-size: 12px; color: var(--muted); margin-top: 4px; }
#miniSignOutBtn { background: #fdeeee; color: #c53939; border:none; border-radius: 6px; padding: 2px 8px; font-size: 11px; font-weight: 600; cursor: pointer; transition: background .2s; }
#miniSignOutBtn:hover { background: #f9dcdc; }
.categories{flex:1;overflow:auto;padding-top:6px; display:flex; flex-direction:column; gap:4px;}
.category{ display:flex;align-items:center;gap:8px;padding:10px;border-radius:10px; cursor:pointer;user-select:none;transition: background .2s, opacity .2s; position:relative; }
.category.dragging{ opacity: 0.5; background: rgba(0,163,255,0.2); }
.category:hover{background:rgba(0,163,255,0.08);}
.category.active{background:rgba(0,163,255,0.12);}
.cat-icon{width:36px;height:36px;border-radius:8px; background:linear-gradient(180deg,#fff,#f3faff); display:flex;align-items:center;justify-content:center;font-weight:700; flex-shrink: 0;}
.cat-name{font-weight:600;flex:1;pointer-events: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
.main{ display:flex;flex-direction:column;height:100%;overflow:hidden; background:linear-gradient(180deg,#ffffff,#f9fcff); padding:24px; }
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.header-title{font-size:20px;font-weight:800;}
#viewControls { display: none; flex-direction: row; gap: 8px; }
#viewControls button { padding: 6px 12px; font-size: 14px; }
.view-btn.active { background: var(--accent); color: white; }
.bookmark-list{flex:1;overflow:auto;display:flex;flex-direction:column;gap:10px;}
.card{ display:flex;align-items:center;gap:12px;background:var(--card); padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,0.05); cursor:grab;transition:transform .1s; }
.card .fav{width:46px;height:46px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700; overflow:hidden; flex-shrink: 0;}
.card .meta{flex:1;min-width:0;}
.card .meta .title{font-weight:700;}
.card .meta .url{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.card .actions{display:flex;gap:6px;}
.icon-btn{width:32px;height:32px;border-radius:8px;display:grid;place-items:center; border:1px solid rgba(0,0,0,0.05);cursor:pointer; background: #fff; flex-shrink: 0;}
.icon-btn:hover{background:#f0f0f0;}
.delete-cat, .edit-cat{ display:none; }
.category:hover .delete-cat, .category:hover .edit-cat{ display:grid; }
#homeBtn { display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 600; font-size: 15px; }
#homeBtn svg { width: 22px; height: 22px; }
.content-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:18px; }
.grid-tile{ background:var(--card);border-radius:16px;padding:16px;text-align:center; box-shadow:0 6px 16px rgba(0,0,0,0.04); transition:transform .2s;cursor:pointer; text-decoration: none; color: inherit;}
.grid-tile:hover{transform:translateY(-3px);}
.grid-tile img{width:48px;height:48px;border-radius:12px;margin-bottom:8px; object-fit:cover;}
.grid-tile .title{font-weight:600;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%;}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(8,15,28,0.35);z-index:100;}
.modal.active{display:flex;}
.modal-card{ width:400px;background:var(--card);padding:20px;border-radius:14px; box-shadow:0 20px 40px rgba(0,0,0,0.15); }
.form-group { margin-bottom: 12px; }
label{font-size:13px;color:var(--muted);display:block; margin-bottom: 4px;}
input[type=text], input[type=number], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.1);box-sizing:border-box;}
.modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px;}
.btn{padding:8px 12px;border-radius:10px;background:#f4f7fa;border:1px solid rgba(0,0,0,0.05);cursor:pointer;}
.btn:hover{background:#e8eff5;}
.switch{display:flex;align-items:center;gap:8px;margin-top:12px; user-select:none;}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar" id="sidebar">
    <div id="versionInfo">v1.9</div>
    <div class="brand">
      <div class="logo" id="userLogo">Y</div>
      <div>
        <h1 id="sidebarTitle">My Bookmarks</h1>
        <div id="sidebarSubtitleContainer" style="display: none;">
            <span id="sidebarSubtitle"></span>
            <button id="miniSignOutBtn">Sign Out</button>
        </div>
      </div>
    </div>
    <button class="btn" id="loginBtn">Sign in with Google</button>
    <hr style="border:none; border-top:1px solid #eee; margin: 0;">
    <button class="btn" id="homeBtn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z"></path></svg>
        Home
    </button>
    <button class="btn" id="addCategoryBtn" style="display:none;">+ Add Category</button>
    <div class="categories" id="categories"></div>
  </aside>

  <main class="main" id="main">
    <div class="header">
      <div class="header-title" id="pageTitle">Home</div>
      <div id="viewControls">
        <button class="btn view-btn active" id="listViewBtn">List</button>
        <button class="btn view-btn" id="cardViewBtn">Card</button>
      </div>
    </div>
    <div id="contentArea"></div>
  </main>
</div>

<!-- MODALS -->
<div class="modal" id="modal">
  <div class="modal-card">
    <h3 id="modalTitle">Add/Edit Bookmark</h3>
    <div class="form-group"><label for="mTitle">Title</label><input id="mTitle" type="text"></div>
    <div class="form-group"><label for="mUrl">URL</label><input id="mUrl" type="text"></div>
    <div class="form-group"><label for="mCategory">Category</label><select id="mCategory"></select></div>
    <div class="form-group"><label for="mIcon">Icon URL (optional)</label><input id="mIcon" type="text"></div>
    <div class="switch"><input type="checkbox" id="mShowHome"><label for="mShowHome">Show on Home</label></div>
    <div class="modal-actions">
      <button class="btn" id="cancelModal">Cancel</button>
      <button class="btn" id="saveModal">Save</button>
    </div>
  </div>
</div>

<div class="modal" id="modalCategory">
  <div class="modal-card">
    <h3>Add Category</h3>
    <div class="form-group"><label for="cTitle">Category Name</label><input id="cTitle" type="text"></div>
    <div class="modal-actions">
      <button class="btn" id="cancelCategory">Cancel</button>
      <button class="btn" id="saveCategory">Save</button>
    </div>
  </div>
</div>

<div class="modal" id="modalCategoryEdit">
  <div class="modal-card">
    <h3>Edit Category</h3>
    <div class="form-group"><label for="ceTitle">Category Name</label><input id="ceTitle" type="text"></div>
    <div class="form-group"><label for="ceOrder">Order (lower number is higher)</label><input id="ceOrder" type="number" min="0"></div>
    <div class="modal-actions">
      <button class="btn" id="cancelCategoryEdit">Cancel</button>
      <button class="btn" id="saveCategoryEdit">Save</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBZ5oi1Vb-cNFQIk04rKMDwLJWVx06DfmI", // LÃ¼tfen kendi Firebase config bilgilerinizle deÄŸiÅŸtirin
    authDomain: "my-g-bookmarks.firebaseapp.com",
    projectId: "my-g-bookmarks",
    storageBucket: "my-g-bookmarks.firebasestorage.app",
    messagingSenderId: "702837130313",
    appId: "1:702837130313:web:bb7e64d33a772ed3d1eb98",
    measurementId: "G-WZVPMS2XY4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();

// --- STATE MANAGEMENT ---
let BOOKMARKS = [];
let currentUser = null;
let currentView = 'home'; // 'home' or a category ID
let viewMode = 'list'; // 'list' or 'card'
let editingState = { bookmarkId: null, categoryId: null };

const $ = (selector) => document.querySelector(selector);

// --- CORE APP LOGIC ---
function sortCategories() { BOOKMARKS.sort((a, b) => (a.order ?? 999) - (b.order ?? 999)); }
function renderApp() {
    sortCategories();
    renderCategories();
    if (currentView === 'home') renderHome();
    else renderCategory(currentView);
}
async function handleDataChange() { await saveBookmarks(); renderApp(); }

// --- AUTHENTICATION ---
onAuthStateChanged(auth, async user => {
    currentUser = user;
    if (user) {
        $('#sidebarTitle').textContent = user.displayName || 'Bookmarks';
        $('#sidebarSubtitle').textContent = user.email;
        $('#sidebarSubtitleContainer').style.display = 'flex';
        $('#userLogo').innerHTML = user.photoURL ? `<img src="${user.photoURL}" alt="User">` : (user.displayName || 'U').charAt(0);
        $('#loginBtn').style.display = 'none';
        $('#addCategoryBtn').style.display = 'block';
        
        const snap = await getDoc(doc(db, "bookmarks", currentUser.uid));
        BOOKMARKS = (snap.exists() ? snap.data().categories : []) || [];
        BOOKMARKS.forEach((cat, i) => {
            if (cat.order === undefined) cat.order = i;
            cat.items = (cat.items || []).map(item => ({...item, showHome: !!item.showHome}));
        });
        currentView = 'home';
        renderApp();
    } else {
        $('#sidebarTitle').textContent = 'My Bookmarks';
        $('#sidebarSubtitleContainer').style.display = 'none';
        $('#userLogo').textContent = 'Y';
        $('#loginBtn').style.display = 'block';
        $('#addCategoryBtn').style.display = 'none';
        BOOKMARKS = [];
        currentView = 'home';
        renderApp();
        $('#contentArea').innerHTML = "<div style='padding:20px; color:var(--muted)'>Please sign in.</div>";
    }
});

// --- DATA PERSISTENCE ---
async function saveBookmarks() {
Â  Â  if (!currentUser) return;

Â  Â  // Kaydetmeden Ã¶nce veriyi temizle
Â  Â  const cleanedBookmarks = BOOKMARKS.map(cat => {
Â  Â  Â  Â  const cleanedCat = { ...cat };
Â  Â  Â  Â  // Kategori Ã¶ÄŸelerini temizle
Â  Â  Â  Â  cleanedCat.items = (cat.items || []).map(item => {
Â  Â  Â  Â  Â  Â  const cleanedItem = {};
Â  Â  Â  Â  Â  Â  for (const key in item) {
Â  Â  Â  Â  Â  Â  Â  Â  // undefined olmayan tÃ¼m alanlarÄ± kopyala
Â  Â  Â  Â  Â  Â  Â  Â  if (item[key] !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cleanedItem[key] = item[key];
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return cleanedItem;
Â  Â  Â  Â  });

Â  Â  Â  Â  // Kategori alanlarÄ±nÄ± temizle (e.g. order)
Â  Â  Â  Â  for (const key in cleanedCat) {
Â  Â  Â  Â  Â  Â  if (cleanedCat[key] === undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  delete cleanedCat[key];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  return cleanedCat;
Â  Â  });
Â  Â  Â  Â  
Â  Â  try {
Â  Â  Â  Â  await setDoc(doc(db, "bookmarks", currentUser.uid), { categories: cleanedBookmarks }); // TemizlenmiÅŸ veriyi kaydet
Â  Â  Â  Â  console.log('Data saved successfully');
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Error saving data: ', error);
Â  Â  Â  Â  alert('Failed to save data: ' + error.message);
Â  Â  }
}

// --- UI RENDERING & HELPERS ---
function createFaviconHTML(item, defaultChar) {
    if (item.icon) {
        return `<img src="${item.icon}" alt="" onerror="this.parentElement.innerHTML = '${defaultChar}'">`;
    }
    let hostname = '';
    try { hostname = new URL(item.url).hostname; } catch (e) {}
    if (hostname) {
        const primarySrc = `https://www.google.com/s2/favicons?domain=${hostname}&sz=64`;
        const fallbackSrc = `https://t1.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=http://${hostname}&size=64`;
        return `<img src="${primarySrc}" alt="" onerror="this.onerror=null; this.src='${fallbackSrc}';">`;
    }
    return defaultChar;
}

function renderCategories() {
    const categoriesEl = $('#categories');
    categoriesEl.innerHTML = '';
    BOOKMARKS.forEach(cat => {
        const el = document.createElement('div');
        el.className = 'category' + (cat.id === currentView ? ' active' : '');
        el.dataset.id = cat.id;
        el.innerHTML = `<div class="cat-icon">${cat.title.charAt(0).toUpperCase()}</div><div class="cat-name">${cat.title}</div><button class="icon-btn edit-cat">ğŸ–Šï¸</button><button class="icon-btn delete-cat">ğŸ—‘ï¸</button>`;
        categoriesEl.appendChild(el);
    });
}

function renderHome() {
    $('#pageTitle').textContent = 'Home';
    $('#viewControls').style.display = 'none';
    const homeItems = BOOKMARKS.flatMap(c => (c.items || []).filter(i => i.showHome));
    const contentArea = $('#contentArea');

    // Ana iÃ§erik alanÄ±nÄ± temizle
    contentArea.innerHTML = '';

    // TÃ¼m ana sayfa iÃ§eriÄŸi iÃ§in bir sarmalayÄ±cÄ± oluÅŸtur
    const homeContainer = document.createElement('div');
    homeContainer.style.cssText = "display: flex; flex-direction: column; gap: 24px;";

    // --- BÃ–LÃœM 1: Favori Yer Ä°mleri ---
    const favoritesSection = document.createElement('div');
    const favoritesHeader = document.createElement('h2');
    favoritesHeader.textContent = 'Favori Bookmarklar';
    favoritesHeader.style.cssText = "font-size: 18px; font-weight: 700; margin-bottom: 12px;";
    favoritesSection.appendChild(favoritesHeader);

    if (homeItems.length === 0) {
        favoritesSection.innerHTML += "<div style='padding:20px; color:var(--muted)'>Ana Sayfaya eklenmiÅŸ yer imi bulunmuyor.</div>";
    } else {
        const grid = document.createElement('div');
        grid.className = 'content-grid';
        homeItems.forEach(item => {
            const tile = document.createElement('a');
            tile.className = 'grid-tile';
            tile.href = item.url;
            tile.target = '_blank';
            tile.innerHTML = `${createFaviconHTML(item, item.title.charAt(0).toUpperCase())}<div class='title'>${item.title}</div>`;
            grid.appendChild(tile);
        });
        favoritesSection.appendChild(grid);
    }
    homeContainer.appendChild(favoritesSection);


    // --- BÃ–LÃœM 2: Alt BÃ¶lÃ¼m (ÃœÃ§ SÃ¼tunlu YapÄ±) ---
    const bottomSection = document.createElement('div');
    bottomSection.style.cssText = "display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; align-items: start;";
    
    // Sol SÃ¼tun (BoÅŸ Ã–rnek)
    const leftColumn = document.createElement('div');
    leftColumn.innerHTML = "<!-- Sol sÃ¼tun iÃ§eriÄŸi buraya eklenebilir -->";
    bottomSection.appendChild(leftColumn);

    // Orta SÃ¼tun (BoÅŸ Ã–rnek)
    const middleColumn = document.createElement('div');
    middleColumn.innerHTML = "<!-- Orta sÃ¼tun iÃ§eriÄŸi buraya eklenebilir -->";
    bottomSection.appendChild(middleColumn);

    // SaÄŸ SÃ¼tun (Dinamik Hava Durumu BileÅŸeni)
    const rightColumn = document.createElement('div');
    rightColumn.innerHTML = `
    <!-- DÄ°NAMÄ°K HAVA DURUMU BÄ°LEÅENÄ° BAÅLANGICI -->
    <div id="weather-widget-container">
        <style>
            .weather-card { backdrop-filter: blur(10px); background-color: rgba(255, 255, 255, 0.8); border: 1px solid rgba(0,0,0,0.05); color: #333; }
            .weather-card-dark { background-color: rgba(31, 41, 55, 0.8); color: #fff; }
            .weather-loader { text-align: center; padding: 40px; }
            #city-select, #district-select { color: white; background-color: rgba(0,0,0,0.2); }
            #city-select option, #district-select option { color: #333; background: #fff; }
        </style>
        <div class="weather-card max-w-md w-full rounded-xl shadow-xl overflow-hidden transition-all duration-300">
            <div id="weather-widget-content">
                <!-- Header -->
                <div class="bg-blue-500 p-4 text-white">
                    <h1 class="text-xl font-bold">GÃ¶kyÃ¼zÃ¼ GÃ¶zcÃ¼sÃ¼</h1>
                    <div class="flex items-center mt-2">
                        <select id="city-select" class="rounded px-2 py-1 mr-2 border border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-300 w-1/2">
                            <option value="">Ä°l YÃ¼kleniyor...</option>
                        </select>
                        <select id="district-select" class="rounded px-2 py-1 border border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-300 w-1/2" disabled>
                            <option value="">Ã–nce il seÃ§in</option>
                        </select>
                    </div>
                </div>
                <div id="weather-body">
                    <div class="weather-loader">YÃ¼kleniyor...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        if (document.getElementById('city-select').getAttribute('data-initialized')) return;
        document.getElementById('city-select').setAttribute('data-initialized', 'true');

        const citySelect = document.getElementById('city-select');
        const districtSelect = document.getElementById('district-select');
        const weatherBody = document.getElementById('weather-body');
        
        const CITIES_DATA_URL = 'https://raw.githubusercontent.com/ahmet-cetinkaya/turkey-cities/master/cities_of_turkey.json';
        let provincesData = [];

        function getWeatherInfo(code, isDay = true) {
            const info = { description: "AÃ§Ä±k", icon: isDay ? "sun" : "moon" };
            if ([0, 1].includes(code)) { info.description = "AÃ§Ä±k"; info.icon = isDay ? "sun" : "moon"; }
            else if ([2].includes(code)) { info.description = "ParÃ§alÄ± Bulutlu"; info.icon = "cloud"; }
            else if ([3].includes(code)) { info.description = "KapalÄ±"; info.icon = "cloud"; }
            else if ([45, 48].includes(code)) { info.description = "Sisli"; info.icon = "align-justify"; }
            else if ([51, 53, 55, 56, 57].includes(code)) { info.description = "Ã‡iseleme"; info.icon = "cloud-drizzle"; }
            else if ([61, 63, 65, 66, 67].includes(code)) { info.description = "YaÄŸmurlu"; info.icon = "cloud-rain"; }
            else if ([71, 73, 75, 77, 85, 86].includes(code)) { info.description = "KarlÄ±"; info.icon = "cloud-snow"; }
            else if ([80, 81, 82].includes(code)) { info.description = "SaÄŸanak YaÄŸÄ±ÅŸlÄ±"; info.icon = "cloud-lightning"; }
            else if ([95, 96, 99].includes(code)) { info.description = "FÄ±rtÄ±nalÄ±"; info.icon = "wind"; }
            return info;
        }

        function updateWeatherUI(data) {
            const now = new Date();
            const currentInfo = getWeatherInfo(data.current.weather_code, data.current.is_day);

            weatherBody.innerHTML = \`
                <div class="p-4 border-b"><div class="flex justify-between items-center"><div><h2 class="text-2xl font-semibold">Åu An</h2><p class="text-gray-600">\${now.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' })}</p></div><div class="text-right"><div class="flex items-center justify-end"><i data-feather="\${currentInfo.icon}" class="w-12 h-12 text-yellow-500"></i><span class="text-3xl font-bold ml-2">\${Math.round(data.current.temperature_2m)}Â°</span></div><p class="text-gray-600">\${currentInfo.description}</p></div></div></div>
                <div class="p-4 border-b"><h3 class="text-lg font-medium mb-3">Saatlik Tahmin</h3><div class="flex overflow-x-auto space-x-4 pb-2" id="hourly-forecast-items"></div></div>
                <div class="p-4"><h3 class="text-lg font-medium mb-3">5 GÃ¼nlÃ¼k Tahmin</h3><div class="space-y-3" id="daily-forecast-items"></div></div>\`;

            const hourlyContainer = document.getElementById('hourly-forecast-items');
            data.hourly.time.map((t, i) => ({ time: new Date(t), temp: data.hourly.temperature_2m[i], code: data.hourly.weather_code[i] })).filter(h => h.time >= now).slice(0, 6).forEach(h => {
                const hourInfo = getWeatherInfo(h.code);
                hourlyContainer.innerHTML += \`<div class="text-center flex-shrink-0"><p class="text-sm font-medium">\${h.time.getHours()}:00</p><i data-feather="\${hourInfo.icon}" class="w-6 h-6 my-1 text-yellow-500 mx-auto"></i><p>\${Math.round(h.temp)}Â°</p></div>\`;
            });

            const dailyContainer = document.getElementById('daily-forecast-items');
            data.daily.time.map((t, i) => ({ time: new Date(t), max: data.daily.temperature_2m_max[i], min: data.daily.temperature_2m_min[i], code: data.daily.weather_code[i] })).slice(1, 6).forEach(d => {
                const dayInfo = getWeatherInfo(d.code);
                dailyContainer.innerHTML += \`<div class="flex items-center justify-between p-2 rounded-lg bg-gray-50"><p class="font-medium w-24">\${d.time.toLocaleDateString('tr-TR', { weekday: 'long' })}</p><div class="flex items-center"><i data-feather="\${dayInfo.icon}" class="w-5 h-5 mr-2 text-yellow-500"></i><span class="mr-3 w-8 text-right">\${Math.round(d.min)}Â°</span><span class="font-medium w-8 text-right">\${Math.round(d.max)}Â°</span></div></div>\`;
            });
            if (typeof feather !== 'undefined') feather.replace();
        }
        
        async function fetchWeather(lat, lon) {
            weatherBody.innerHTML = '<div class="weather-loader">Hava durumu verisi alÄ±nÄ±yor...</div>';
            try {
                const response = await fetch(\`https://api.open-meteo.com/v1/forecast?latitude=\${lat}&longitude=\${lon}&current=temperature_2m,is_day,weather_code&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Europe/Istanbul\`);
                if (!response.ok) throw new Error('Hava durumu verisi alÄ±namadÄ±.');
                updateWeatherUI(await response.json());
            } catch (error) {
                weatherBody.innerHTML = '<div class="weather-loader text-red-500">Bir hata oluÅŸtu.</div>';
            }
        }

        citySelect.addEventListener('change', function() {
            districtSelect.innerHTML = '<option value="">Ä°lÃ§e seÃ§in</option>';
            districtSelect.disabled = true;
            if (this.value) {
                const province = provincesData.find(p => p.name === this.value);
                if (province) {
                    province.districts.forEach(d => { districtSelect.innerHTML += \`<option value="\${d.name}">\${d.name}</option>\`; });
                    districtSelect.disabled = false;
                }
            }
        });

        districtSelect.addEventListener('change', function() {
            if (citySelect.value && this.value) {
                const p = provincesData.find(p => p.name === citySelect.value);
                const d = p.districts.find(d => d.name === this.value);
                if (d) fetchWeather(d.latitude, d.longitude);
            }
        });

        async function initializeWeatherWidget() {
            try {
                const response = await fetch(CITIES_DATA_URL);
                provincesData = await response.json();
                citySelect.innerHTML = '<option value="">Ä°l seÃ§in</option>';
                provincesData.forEach(p => { citySelect.innerHTML += \`<option value="\${p.name}">\${p.name}</option>\`; });
                citySelect.value = 'Ä°stanbul';
                citySelect.dispatchEvent(new Event('change'));
                districtSelect.value = 'KadÄ±kÃ¶y';
                districtSelect.dispatchEvent(new Event('change'));
            } catch (error) {
                weatherBody.innerHTML = '<div class="weather-loader text-red-500">Widget yÃ¼klenemedi.</div>';
                citySelect.innerHTML = '<option value="">Hata!</option>';
            }
        }
        initializeWeatherWidget();
    })();
    <\/script>
    <!-- DÄ°NAMÄ°K HAVA DURUMU BÄ°LEÅENÄ° SONU -->
    `;
    bottomSection.appendChild(rightColumn);
    
    // Alt bÃ¶lÃ¼mÃ¼ ana sarmalayÄ±cÄ±ya ekle
    homeContainer.appendChild(bottomSection);
    
    // TÃ¼m ana sayfa iÃ§eriÄŸini contentArea'ya ekle
    contentArea.appendChild(homeContainer);
}

function renderCategory(catId) {
    const cat = BOOKMARKS.find(c => c.id === catId);
    if (!cat) { currentView = 'home'; renderApp(); return; }

    $('#pageTitle').textContent = cat.title;
    $('#viewControls').style.display = 'flex';
    $('#listViewBtn').classList.toggle('active', viewMode === 'list');
    $('#cardViewBtn').classList.toggle('active', viewMode === 'card');

    const contentArea = $('#contentArea');
    contentArea.innerHTML = '';
    const items = cat.items || [];
    const container = document.createElement('div');

    if (items.length > 0) {
        container.className = viewMode === 'list' ? 'bookmark-list' : 'content-grid';
        items.forEach(item => {
            const el = document.createElement(viewMode === 'list' ? 'div' : 'a');
            el.className = viewMode === 'list' ? 'card' : 'grid-tile';
            
            if(viewMode === 'list') {
                el.dataset.id = item.id;
                el.dataset.categoryId = cat.id;
                const iconHtml = createFaviconHTML(item, item.title.charAt(0).toUpperCase());
                el.innerHTML = `
                    <a href="${item.url}" target="_blank" class="fav" style="background:${cat.color||'#00a3ff'}; color:white; text-decoration:none; display:flex; align-items:center; justify-content:center;">${iconHtml}</a>
                    <div class="meta"><a href="${item.url}" target="_blank" style="text-decoration:none; color:inherit;"><div class="title">${item.title}</div></a><div class="url">${item.url}</div></div>
                    <div class="actions"><button class="icon-btn edit-btn">âœï¸</button><button class="icon-btn delete-btn">ğŸ—‘ï¸</button></div>`;
            } else {
                el.href = item.url;
                el.target = '_blank';
                el.innerHTML = `${createFaviconHTML(item, item.title.charAt(0).toUpperCase())}<div class='title'>${item.title}</div>`;
            }
            container.appendChild(el);
        });
    } else {
        container.innerHTML = `<div style='padding:20px; color:var(--muted)'>This category is empty.</div>`;
    }
    contentArea.appendChild(container);
    
    const addBtn = document.createElement('button');
    addBtn.textContent = '+ Add Bookmark';
    addBtn.className = 'btn';
    addBtn.style.marginTop = '20px';
    contentArea.appendChild(addBtn);
}

// --- MODAL & DATA MANIPULATION ---
function findBookmark(bookmarkId) {
    for (const category of BOOKMARKS) {
        const bookmark = (category.items || []).find(item => item.id === bookmarkId);
        if (bookmark) return { bookmark, category };
    }
    return { bookmark: null, category: null };
}

function populateCategorySelect(selectedId = null) {
    const select = $('#mCategory');
    select.innerHTML = '';
    BOOKMARKS.forEach(cat => {
        select.innerHTML += `<option value="${cat.id}" ${cat.id === selectedId ? 'selected' : ''}>${cat.title}</option>`;
    });
}

function openModalForEdit(bookmarkId, categoryId) {
    const { bookmark } = findBookmark(bookmarkId);
    if (!bookmark) return;
    editingState = { bookmarkId, categoryId };
    $('#modalTitle').textContent = "Edit Bookmark";
    $('#mTitle').value = bookmark.title;
    $('#mUrl').value = bookmark.url;
    $('#mIcon').value = bookmark.icon || '';
    $('#mShowHome').checked = !!bookmark.showHome;
    populateCategorySelect(categoryId);
    $('#modal').classList.add('active');
}

function openModalForAdd() {
    if (currentView === 'home') { alert("Please select a category first."); return; }
    editingState = { bookmarkId: null, categoryId: currentView };
    $('#modalTitle').textContent = "Add Bookmark";
    $('#mTitle').value = ''; $('#mUrl').value = ''; $('#mIcon').value = ''; $('#mShowHome').checked = false;
    populateCategorySelect(currentView);
    $('#modal').classList.add('active');
}

$('#saveModal').onclick = async () => {
    const title = $('#mTitle').value.trim();
    let url = $('#mUrl').value.trim();
    const newCatId = $('#mCategory').value;
    if (!title || !url || !newCatId) return alert("Title, URL, and Category are required.");
    if (!url.match(/^https?:\/\//i)) url = 'https://' + url;

    const bookmarkData = { title, url, icon: $('#mIcon').value.trim() || undefined, showHome: !!$('#mShowHome').checked };
    const newCat = BOOKMARKS.find(c => c.id === newCatId);
    if (!newCat) return alert("Invalid category.");

    if (editingState.bookmarkId) {
        const { bookmark, category } = findBookmark(editingState.bookmarkId);
        if (bookmark) {
            Object.assign(bookmark, bookmarkData);
            if (newCatId !== editingState.categoryId) {
                category.items = (category.items || []).filter(i => i.id !== editingState.bookmarkId);
                newCat.items = newCat.items || []; newCat.items.push(bookmark);
            }
        }
    } else {
        newCat.items = newCat.items || []; newCat.items.push({ id: 'b_' + Date.now(), ...bookmarkData });
    }
    currentView = newCatId;
    $('#modal').classList.remove('active');
    await handleDataChange();
};

function openCategoryEditModal(catId) {
    const cat = BOOKMARKS.find(c => c.id === catId);
    if (!cat) return;
    editingState.categoryId = catId;
    $('#ceTitle').value = cat.title;
    $('#ceOrder').value = cat.order ?? '';
    $('#modalCategoryEdit').classList.add('active');
}

$('#saveCategoryEdit').onclick = () => {
    const title = $('#ceTitle').value.trim();
    const order = parseInt($('#ceOrder').value);
    if (!title) return alert("Category name is required.");
    const catId = editingState.categoryId;
    const cat = BOOKMARKS.find(c => c.id === catId);
    if (cat) {
        if (BOOKMARKS.some(c => c.id !== catId && c.title.toLowerCase() === title.toLowerCase())) {
            return alert(`Category "${title}" already exists.`);
        }
        cat.title = title;
        cat.order = isNaN(order) ? 999 : order;
    }
    $('#modalCategoryEdit').classList.remove('active');
    handleDataChange();
};

$('#saveCategory').onclick = () => {
    const title = $('#cTitle').value.trim();
    if (!title) return;
    if (BOOKMARKS.some(c => c.title.toLowerCase() === title.toLowerCase())) return alert(`Category "${title}" already exists.`);
    const minOrder = BOOKMARKS.length > 0 ? Math.min(...BOOKMARKS.map(c => c.order ?? 0)) : 0;
    BOOKMARKS.unshift({ id: 'cat_' + Date.now(), title, order: minOrder - 1, color: `#${Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')}`, items: [] });
    $('#modalCategory').classList.remove('active');
    handleDataChange();
};

// --- EVENT LISTENERS ---
$('#loginBtn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => console.error("Sign in error", e));
$('#miniSignOutBtn').onclick = () => signOut(auth);
$('#homeBtn').onclick = () => { currentView = 'home'; renderApp(); };
$('#addCategoryBtn').onclick = () => { $('#cTitle').value = ''; $('#modalCategory').classList.add('active'); };
$('#listViewBtn').onclick = () => { viewMode = 'list'; renderApp(); };
$('#cardViewBtn').onclick = () => { viewMode = 'card'; renderApp(); };

$('#categories').addEventListener('click', e => {
    const categoryEl = e.target.closest('.category');
    if (!categoryEl) return;
    const catId = categoryEl.dataset.id;
    if (e.target.closest('.edit-cat')) openCategoryEditModal(catId);
    else if (e.target.closest('.delete-cat')) {
        if (!confirm("Bookmarks will be moved to 'DiÄŸer' category.")) return;
        const catToDelete = BOOKMARKS.find(c => c.id === catId);
        if (!catToDelete) return;
        let otherCat = BOOKMARKS.find(c => c.id === 'cat_other');
        if (!otherCat) {
            otherCat = { id: 'cat_other', title: 'DiÄŸer', color: '#808080', order: 9999, items: [] };
            BOOKMARKS.push(otherCat);
        }
        if ((catToDelete.items || []).length > 0) {
            otherCat.items = [...(otherCat.items || []), ...catToDelete.items];
        }
        BOOKMARKS = BOOKMARKS.filter(c => c.id !== catId);
        if (currentView === catId) currentView = 'home';
        handleDataChange();
    } else {
        currentView = catId; renderApp();
    }
});

$('#contentArea').addEventListener('click', e => {
    const addBtn = e.target.closest('.btn');
    if (addBtn && addBtn.textContent.includes('+ Add Bookmark')) return openModalForAdd();
    const card = e.target.closest('.card');
    if (!card) return;
    if (e.target.closest('.edit-btn')) openModalForEdit(card.dataset.id, card.dataset.categoryId);
    else if (e.target.closest('.delete-btn')) {
        if (!confirm("Are you sure?")) return;
        const { category } = findBookmark(card.dataset.id);
        if (category) category.items = (category.items || []).filter(i => i.id !== card.dataset.id);
        handleDataChange();
    }
});

// Close Modals
[$('#cancelModal'), $('#cancelCategory'), $('#cancelCategoryEdit')].forEach(btn => btn.onclick = () => btn.closest('.modal').classList.remove('active'));
document.addEventListener('keydown', e => { if (e.key === 'Escape') [$('#modal'), $('#modalCategory'), $('#modalCategoryEdit')].forEach(m => m.classList.remove('active')); });
</script>
</body>
</html>


