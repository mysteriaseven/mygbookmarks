<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>My Bookmarks v2.0</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{ --bg:linear-gradient(135deg, #667eea 0%, #764ba2 100%); --card:rgba(255,255,255,.95); --muted:#e0e6ff; --accent:#667eea; font-family:'Inter',sans-serif; }
html,body{margin:0;height:100%;background:var(--bg);color:#fff;}
.app{display:grid;grid-template-columns:280px 1fr;height:100vh;}
.sidebar{background:var(--bg);border-right:1px solid rgba(255,255,255,.1);padding:20px;display:flex;flex-direction:column;gap:16px;color:#fff;}
#versionInfo{background:rgba(255,255,255,.2);color:#fff;padding:3px 8px;border-radius:8px;font-size:12px;font-weight:600;align-self:flex-start;margin-bottom:8px;}
.brand{display:flex;align-items:center;gap:12px;}
.logo{width:48px;height:48px;border-radius:50%;background:conic-gradient(from 180deg,#fff,#e0e6ff,#a8e6cf,#ffd93d,#fff);display:flex;align-items:center;justify-content:center;font-weight:800;color:#667eea;overflow:hidden;}
.logo img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
h1{font-size:17px;margin:0;color:#fff;}
#sidebarSubtitleContainer{display:flex;align-items:center;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:4px;}
#miniSignOutBtn{background:rgba(255,255,255,.1);color:#fff;border:none;border-radius:6px;padding:2px 8px;font-size:11px;font-weight:600;cursor:pointer;transition:background .2s;}
#miniSignOutBtn:hover{background:rgba(255,255,255,.2);}
.categories{flex:1;overflow:auto;padding-top:6px;display:flex;flex-direction:column;gap:4px;}
.category{display:flex;align-items:center;gap:8px;padding:10px;border-radius:10px;cursor:pointer;user-select:none;transition:background .2s,opacity .2s,transform .2s;position:relative;box-shadow:0 5px 15px rgba(0,0,0,.2);background:rgba(255,255,255,.1);}
.category:hover{background:rgba(255,255,255,.2);transform:translateY(-2px);}
.category.active{background:rgba(255,255,255,.3);}
.cat-icon{width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;color:#fff;}
.cat-name{font-weight:600;flex:1;pointer-events:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#fff;}
.main{display:flex;flex-direction:column;height:100%;overflow:hidden;background:var(--card);padding:24px;border-radius:20px 0 0 20px;margin:20px 0;box-shadow:0 20px 60px rgba(0,0,0,.3);color:#333;}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.header-title{font-size:20px;font-weight:800;color:#333;}
.content-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:18px;}
.grid-tile{background:var(--bg);border-radius:20px;padding:16px;text-align:center;box-shadow:0 6px 16px rgba(0,0,0,.1);transition:transform .2s,box-shadow .2s;cursor:pointer;text-decoration:none;color:#fff;}
.grid-tile:hover{transform:translateY(-3px);box-shadow:0 10px 25px rgba(102,126,234,.3);}
.grid-tile img{width:48px;height:48px;border-radius:12px;margin-bottom:8px;object-fit:cover;}
.grid-tile .title{font-weight:600;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%;color:#fff;}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(8,15,28,.35);z-index:100;}
.modal.active{display:flex;}
.modal-card{width:400px;background:var(--card);padding:20px;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.15);backdrop-filter:blur(10px);color:#333;}
.form-group{margin-bottom:12px;}
label{font-size:13px;color:#666;display:block;margin-bottom:4px;}
input[type=text],input[type=number],select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,.1);box-sizing:border-box;}
.modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px;}
.btn{padding:8px 12px;border-radius:10px;background:var(--bg);border:1px solid rgba(0,0,0,.05);cursor:pointer;transition:background .2s;color:#fff;}
.btn:hover{background:linear-gradient(135deg,#5a6fd8 0%,#6a4190 100%);}
.switch{display:flex;align-items:center;gap:8px;margin-top:12px;user-select:none;}
.delete-cat,.edit-cat{display:none;}
.category:hover .delete-cat,.category:hover .edit-cat{display:grid;}
#homeBtn{display:flex;align-items:center;justify-content:center;gap:8px;font-weight:600;font-size:15px;border-radius:20px;background:rgba(255,255,255,.1);color:#fff;}
#homeBtn svg{width:22px;height:22px;}
iframe{border:none;border-radius:20px;width:100%;height:260px;margin-top:24px;}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar" id="sidebar">
    <div id="versionInfo">v2.0</div>
    <div class="brand">
      <div class="logo" id="userLogo">Y</div>
      <div>
        <h1 id="sidebarTitle">My Bookmarks</h1>
        <div id="sidebarSubtitleContainer" style="display:none;">
          <span id="sidebarSubtitle"></span>
          <button id="miniSignOutBtn">Sign Out</button>
        </div>
      </div>
    </div>
    <button class="btn" id="loginBtn">Sign in with Google</button>
    <hr style="border:none;border-top:1px solid rgba(255,255,255,.2);margin:0;">
    <button class="btn" id="homeBtn">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z"/></svg>
      Home
    </button>
    <button class="btn" id="addCategoryBtn" style="display:none;">+ Add Category</button>
    <div class="categories" id="categories"></div>
  </aside>

  <main class="main" id="main">
    <div class="header">
      <div class="header-title" id="pageTitle">Home</div>
    </div>
    <div id="contentArea"></div>
    <!-- Widget’lar iframe ile ayrı dosyalardan çekiliyor -->
    <iframe id="weatherIframe" src="weatherwidget.html" title="Hava Durumu"></iframe>
    <iframe id="radioIframe" src="radiowidget.html" title="Radyo"></iframe>
  </main>
</div>

<!-- MODALS -->
<div class="modal" id="modal"><div class="modal-card">
  <h3 id="modalTitle">Add/Edit Bookmark</h3>
  <div class="form-group"><label for="mTitle">Title</label><input id="mTitle" type="text"></div>
  <div class="form-group"><label for="mUrl">URL</label><input id="mUrl" type="text"></div>
  <div class="form-group"><label for="mCategory">Category</label><select id="mCategory"></select></div>
  <div class="form-group"><label for="mIcon">Icon URL (optional)</label><input id="mIcon" type="text"></div>
  <div class="switch"><input type="checkbox" id="mShowHome"><label for="mShowHome">Show on Home</label></div>
  <div class="modal-actions"><button class="btn" id="cancelModal">Cancel</button><button class="btn" id="saveModal">Save</button></div>
</div></div>

<div class="modal" id="modalCategory"><div class="modal-card">
  <h3>Add Category</h3>
  <div class="form-group"><label for="cTitle">Category Name</label><input id="cTitle" type="text"></div>
  <div class="modal-actions"><button class="btn" id="cancelCategory">Cancel</button><button class="btn" id="saveCategory">Save</button></div>
</div></div>

<div class="modal" id="modalCategoryEdit"><div class="modal-card">
  <h3>Edit Category</h3>
  <div class="form-group"><label for="ceTitle">Category Name</label><input id="ceTitle" type="text"></div>
  <div class="form-group"><label for="ceOrder">Order (lower = higher)</label><input id="ceOrder" type="number" min="0"></div>
  <div class="modal-actions"><button class="btn" id="cancelCategoryEdit">Cancel</button><button class="btn" id="saveCategoryEdit">Save</button></div>
</div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBZ5oi1Vb-cNFQIk04rKMDwLJWVx06DfmI",
    authDomain: "my-g-bookmarks.firebaseapp.com",
    projectId: "my-g-bookmarks",
    storageBucket: "my-g-bookmarks.firebasestorage.app",
    messagingSenderId: "702837130313",
    appId: "1:702837130313:web:bb7e64d33a772ed3d1eb98",
    measurementId: "G-WZVPMS2XY4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();

// ---- STATE ----
let BOOKMARKS = [], currentUser = null, currentView = 'home', editingState = {bookmarkId:null, categoryId:null};
const $ = s => document.querySelector(s);

// ---- CORE ----
function sortCategories(){BOOKMARKS.sort((a,b)=>(a.order??999)-(b.order??999));}
function renderApp(){sortCategories();renderCategories(); currentView==='home'?renderHome():renderCategory(currentView);}
async function handleDataChange(){await saveBookmarks();renderApp();}

// ---- AUTH ----
onAuthStateChanged(auth, async user=>{
  currentUser=user;
  if(user){
    $('#sidebarTitle').textContent=user.displayName||'Bookmarks';
    $('#sidebarSubtitle').textContent=user.email;
    $('#sidebarSubtitleContainer').style.display='flex';
    $('#userLogo').innerHTML=user.photoURL?`<img src="${user.photoURL}" alt="User">`:(user.displayName||'U').charAt(0);
    $('#loginBtn').style.display='none';
    $('#addCategoryBtn').style.display='block';
    const snap=await getDoc(doc(db,"bookmarks",user.uid));
    BOOKMARKS=(snap.exists()?snap.data().categories:[])||[];
    BOOKMARKS.forEach((c,i)=>{if(c.order===undefined)c.order=i; c.items=(c.items||[]).map(it=>({...it,showHome:!!it.showHome}));});
    currentView='home';renderApp();
  }else{
    $('#sidebarTitle').textContent='My Bookmarks';
    $('#sidebarSubtitleContainer').style.display='none';
    $('#userLogo').textContent='Y';
    $('#loginBtn').style.display='block';
    $('#addCategoryBtn').style.display='none';
    BOOKMARKS=[];currentView='home';renderApp();
    $('#contentArea').innerHTML="<div style='padding:20px;color:#666'>Please sign in.</div>";
  }
});

// ---- PERSISTENCE ----
async function saveBookmarks(){
  if(!currentUser)return;
  const cleaned=BOOKMARKS.map(cat=>{
    const c={...cat};
    c.items=(cat.items||[]).map(it=>{const o={};for(const k in it)if(it[k]!==undefined)o[k]=it[k];return o;});
    for(const k in c)if(c[k]===undefined)delete c[k];
    return c;
  });
  await setDoc(doc(db,"bookmarks",currentUser.uid),{categories:cleaned});
}

// ---- UI ----
function createFaviconHTML(item,def){
  if(item.icon)return `<img src="${item.icon}" alt="" onerror="this.parentElement.innerHTML='${def}'">`;
  let h='';try{h=new URL(item.url).hostname;}catch{}
  if(h){
    const p=`https://www.google.com/s2/favicons?domain=${h}&sz=64`;
    const f=`https://t1.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=http://${h}&size=64`;
    return `<img src="${p}" alt="" onerror="this.onerror=null;this.src='${f}';">`;
  }
  return def;
}
function renderCategories(){
  const el=$('#categories');el.innerHTML='';
  BOOKMARKS.forEach(cat=>{
    const div=document.createElement('div');
    div.className='category'+(cat.id===currentView?' active':'');
    div.dataset.id=cat.id;
    div.innerHTML=`<div class="cat-icon">${cat.title.charAt(0).toUpperCase()}</div><div class="cat-name">${cat.title}</div><button class="icon-btn edit-cat">Edit</button><button class="icon-btn delete-cat">Delete</button>`;
    el.appendChild(div);
  });
}
function renderHome(){
  $('#pageTitle').textContent='Home';
  const items=BOOKMARKS.flatMap(c=>(c.items||[]).filter(i=>i.showHome));
  const area=$('#contentArea');area.innerHTML='';
  const sec=document.createElement('div');
  const h=document.createElement('h2');h.textContent='Favori Bookmarklar';
  h.style.cssText='font-size:18px;font-weight:700;margin-bottom:12px;color:#333;';
  sec.appendChild(h);
  if(!items.length)sec.innerHTML+="<div style='padding:20px;color:#666'>Ana sayfaya eklenmiş yer imi yok.</div>";
  else{
    const grid=document.createElement('div');grid.className='content-grid';
    items.forEach(it=>{
      const a=document.createElement('a');a.className='grid-tile';a.href=it.url;a.target='_blank';
      a.innerHTML=`${createFaviconHTML(it,it.title.charAt(0).toUpperCase())}<div class='title'>${it.title}</div>`;
      grid.appendChild(a);
    });
    sec.appendChild(grid);
  }
  area.appendChild(sec);
}
function renderCategory(id){
  const cat=BOOKMARKS.find(c=>c.id===id);
  if(!cat){currentView='home';renderApp();return;}
  $('#pageTitle').textContent=cat.title;
  const area=$('#contentArea');area.innerHTML='';
  const items=cat.items||[];
  const container=document.createElement('div');container.className='content-grid';
  if(items.length){
    items.forEach(it=>{
      const a=document.createElement('a');a.className='grid-tile';a.href=it.url;a.target='_blank';
      a.innerHTML=`${createFaviconHTML(it,it.title.charAt(0).toUpperCase())}<div class='title'>${it.title}</div>`;
      container.appendChild(a);
    });
  }else container.innerHTML=`<div style='padding:20px;color:#666;grid-column:1/-1;'>Bu kategori boş.</div>`;
  area.appendChild(container);
  const btn=document.createElement('button');btn.textContent='+ Add Bookmark';btn.className='btn';
  btn.style.marginTop='20px';area.appendChild(btn);
}

// ---- MODALS ----
function findBookmark(id){
  for(const c of BOOKMARKS){const b=(c.items||[]).find(i=>i.id===id);if(b)return{b,c};}
  return{b:null,c:null};
}
function populateSelect(sel=null){
  const s=$('#mCategory');s.innerHTML='';
  BOOKMARKS.forEach(c=>s.innerHTML+=`<option value="${c.id}" ${c.id===sel?'selected':''}>${c.title}</option>`);
}
function openAdd(){if(currentView==='home'){alert('Lütfen bir kategori seçin.');return;}
  editingState={bookmarkId:null,categoryId:currentView};
  $('#modalTitle').textContent='Add Bookmark';
  $('#mTitle').value='';$('#mUrl').value='';$('#mIcon').value='';$('#mShowHome').checked=false;
  populateSelect(currentView);$('#modal').classList.add('active');
}
function openEdit(bid,cid){
  const {bookmark}=findBookmark(bid);if(!bookmark)return;
  editingState={bookmarkId:bid,categoryId:cid};
  $('#modalTitle').textContent='Edit Bookmark';
  $('#mTitle').value=bookmark.title;$('#mUrl').value=bookmark.url;
  $('#mIcon').value=bookmark.icon||'';$('#mShowHome').checked=!!bookmark.showHome;
  populateSelect(cid);$('#modal').classList.add('active');
}
$('#saveModal').onclick=async()=>{
  const t=$('#mTitle').value.trim(),u=$('#mUrl').value.trim(),c=$('#mCategory').value;
  if(!t||!u||!c)return alert('Başlık, URL ve Kategori gereklidir.');
  const url=u.match(/^https?:\/\//i)?u:'https://'+u;
  const data={title:t,url,icon:$('#mIcon').value.trim()||undefined,showHome:!!$('#mShowHome').checked};
  const cat=BOOKMARKS.find(x=>x.id===c);if(!cat)return alert('Geçersiz kategori.');
  if(editingState.bookmarkId){
    const {bookmark,category}=findBookmark(editingState.bookmarkId);
    if(bookmark){Object.assign(bookmark,data);
      if(c!==editingState.categoryId){
        category.items=(category.items||[]).filter(i=>i.id!==editingState.bookmarkId);
        cat.items=cat.items||[];cat.items.push(bookmark);
      }
    }
  }else{cat.items=cat.items||[];cat.items.push({id:'b_'+Date.now(),...data});}
  currentView=c;$('#modal').classList.remove('active');await handleDataChange();
};
function openCatEdit(id){
  const cat=BOOKMARKS.find(c=>c.id===id);if(!cat)return;
  editingState.categoryId=id;
  $('#ceTitle').value=cat.title;$('#ceOrder').value=cat.order??'';
  $('#modalCategoryEdit').classList.add('active');
}
$('#saveCategoryEdit').onclick=()=>{
  const t=$('#ceTitle').value.trim(),o=parseInt($('#ceOrder').value);
  if(!t)return alert('Kategori adı gerekli.');
  const id=editingState.categoryId,cat=BOOKMARKS.find(c=>c.id===id);
  if(cat){
    if(BOOKMARKS.some(c=>c.id!==id&&c.title.toLowerCase()===t.toLowerCase()))return alert(`"${t}" zaten var.`);
    cat.title=t;cat.order=isNaN(o)?999:o;
  }
  $('#modalCategoryEdit').classList.remove('active');handleDataChange();
};
$('#saveCategory').onclick=()=>{
  const t=$('#cTitle').value.trim();if(!t)return;
  if(BOOKMARKS.some(c=>c.title.toLowerCase()===t.toLowerCase()))return alert(`"${t}" zaten var.`);
  const min=BOOKMARKS.length?Math.min(...BOOKMARKS.map(c=>c.order??0)):0;
  BOOKMARKS.unshift({id:'cat_'+Date.now(),title:t,order:min-1,color:'#'.concat(Math.floor(Math.random()*16777215).toString(16).padStart(6,'0')),items:[]});
  $('#modalCategory').classList.remove('active');handleDataChange();
};

// ---- EVENTS ----
$('#loginBtn').onclick=()=>signInWithPopup(auth,new GoogleAuthProvider());
$('#miniSignOutBtn').onclick=()=>signOut(auth);
$('#homeBtn').onclick=()=>{currentView='home';renderApp();};
$('#addCategoryBtn').onclick=()=>{ $('#cTitle').value='';$('#modalCategory').classList.add('active');};

$('#categories').addEventListener('click',e=>{
  const el=e.target.closest('.category');if(!el)return;
  const id=el.dataset.id;
  if(e.target.closest('.edit-cat'))openCatEdit(id);
  else if(e.target.closest('.delete-cat')){
    if(!confirm("Yer imleri 'Diğer' kategorisine taşınacak."))return;
    const del=BOOKMARKS.find(c=>c.id===id);if(!del)return;
    let other=BOOKMARKS.find(c=>c.id==='cat_other');
    if(!other){other={id:'cat_other',title:'Diğer',color:'#808080',order:9999,items:[]};BOOKMARKS.push(other);}
    if(del.items?.length)other.items=[...(other.items||[]),...del.items];
    BOOKMARKS=BOOKMARKS.filter(c=>c.id!==id);
    if(currentView===id)currentView='home';
    handleDataChange();
  }else{currentView=id;renderApp();}
});

$('#contentArea').addEventListener('click',e=>{
  const btn=e.target.closest('.btn');
  if(btn && btn.textContent.includes('+ Add Bookmark'))openAdd();
});

[$('#cancelModal'),$('#cancelCategory'),$('#cancelCategoryEdit')].forEach(b=>b.onclick=()=>b.closest('.modal').classList.remove('active'));
document.addEventListener('keydown',e=>{if(e.key==='Escape')[$('#modal'),$('#modalCategory'),$('#modalCategoryEdit')].forEach(m=>m.classList.remove('active'));});

renderApp();
</script>
</body>
</html>
