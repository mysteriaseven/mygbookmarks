<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>My Bookmarks v1.9</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --card: rgba(255, 255, 255, 0.95);
  --card-hover: rgba(255, 255, 255, 1);
  --muted: #e0e6ff;
  --accent: #667eea;
  --text: #333;
  --radius: 20px;
  --shadow: 0 10px 30px rgba(0,0,0,0.15);
  font-family: 'Inter', sans-serif;
}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);}
.app{display:grid;grid-template-columns:280px 1fr;height:100vh;}
.sidebar{background:var(--bg);padding:20px;display:flex;flex-direction:column;gap:16px;color:#fff;}
#versionInfo{background:rgba(255,255,255,0.2);color:#fff;padding:4px 10px;border-radius:8px;font-size:12px;font-weight:600;align-self:flex-start;margin-bottom:8px;}
.brand{display:flex;align-items:center;gap:12px;}
.logo{width:48px;height:48px;border-radius:50%;background:conic-gradient(from 180deg,#fff,#e0e6ff,#a8e6cf,#ffd93d,#fff);display:flex;align-items:center;justify-content:center;font-weight:800;color:#667eea;overflow:hidden;}
.logo img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
h1{font-size:17px;margin:0;color:#fff;}
#sidebarSubtitleContainer{display:flex;align-items:center;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:4px;}
#miniSignOutBtn{background:rgba(255,255,255,0.1);color:#fff;border:none;border-radius:6px;padding:2px 8px;font-size:11px;font-weight:600;cursor:pointer;transition:background .2s;}
#miniSignOutBtn:hover{background:rgba(255,255,255,0.2);}
.categories{flex:1;overflow:auto;padding-top:6px;display:flex;flex-direction:column;gap:4px;}
.category{display:flex;align-items:center;gap:8px;padding:10px;border-radius:12px;cursor:pointer;user-select:none;transition:all .2s;position:relative;background:rgba(255,255,255,0.1);}
.category:hover{background:rgba(255,255,255,0.2);transform:translateY(-1px);}
.category.active{background:rgba(255,255,255,0.3);}
.cat-icon{width:36px;height:36px;border-radius:10px;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;color:#fff;}
.cat-name{font-weight:600;flex:1;pointer-events:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#fff;}
.main{display:flex;flex-direction:column;height:100%;overflow:hidden;background:var(--card);padding:24px;border-radius:var(--radius) 0 0 var(--radius);margin:20px 0;box-shadow:var(--shadow);color:var(--text);}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.header-title{font-size:20px;font-weight:800;color:var(--text);}
.content-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:18px;}
.grid-tile{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:var(--radius);padding:18px;text-align:center;box-shadow:0 6px 16px rgba(0,0,0,0.1);transition:all .3s;cursor:pointer;text-decoration:none;color:#fff;position:relative;overflow:hidden;}
.grid-tile::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.1),transparent);opacity:0;transition:opacity .3s;}
.grid-tile:hover{transform:translateY(-4px);box-shadow:0 12px 28px rgba(102,126,234,0.3);}
.grid-tile:hover::before{opacity:1;}
.grid-tile img{width:48px;height:48px;border-radius:12px;margin-bottom:10px;object-fit:cover;}
.grid-tile .title{font-weight:600;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%;color:#fff;}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(8,15,28,0.5);z-index:100;backdrop-filter:blur(8px);}
.modal.active{display:flex;}
.modal-card{width:420px;background:var(--card);padding:24px;border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(12px);color:var(--text);}
.form-group{margin-bottom:14px;}
label{font-size:13px;color:#666;display:block;margin-bottom:6px;font-weight:600;}
input[type=text],input[type=number],textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.1);box-sizing:border-box;font-size:14px;}
.modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:16px;}
.btn{padding:10px 16px;border-radius:12px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;cursor:pointer;transition:all .2s;color:#fff;font-weight:600;}
.btn:hover{background:linear-gradient(135deg,#5a6fd8 0%,#6a4190 100%);}
.switch{display:flex;align-items:center;gap:8px;margin-top:12px;user-select:none;font-size:14px;color:#555;}
.switch input{margin-right:8px;}

/* Weather Widget - Modern */
.widget-container{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:row;min-height:220px;}
.widget-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:18px;color:#fff;position:relative;overflow:hidden;flex:1;min-width:220px;display:flex;flex-direction:column;justify-content:center;}
.weather-animation{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:hidden;}
.rain-drop{position:absolute;width:2px;height:20px;background:linear-gradient(transparent,rgba(255,255,255,0.7));animation:rain-fall linear infinite;}
@keyframes rain-fall{to{transform:translateY(250px);}}
.snow-flake{position:absolute;width:8px;height:8px;background:#fff;border-radius:50%;animation:snow-fall linear infinite;}
@keyframes snow-fall{to{transform:translateY(250px) rotate(360deg);}}
.sun-rays{position:absolute;top:50%;right:20px;width:60px;height:60px;font-size:42px;animation:rotate 18s linear infinite;}
@keyframes rotate{to{transform:rotate(360deg);}}
.district-selector select{width:100%;padding:8px 12px;border:none;border-radius:10px;background:rgba(255,255,255,0.2);color:#fff;font-size:13px;cursor:pointer;outline:none;}
.current-weather{display:flex;justify-content:space-between;align-items:center;margin:12px 0;}
.current-temp{font-size:38px;font-weight:800;}
.weather-icon-main{font-size:44px;}
.weather-desc{font-size:13px;text-align:center;margin-top:4px;}
.weather-details{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:8px;}
.detail-item{display:flex;align-items:center;gap:5px;font-size:12px;}
.detail-icon{font-size:15px;}
.api-notice{background:rgba(255,255,255,0.2);padding:6px;border-radius:6px;font-size:9px;margin-top:8px;text-align:center;}
.widget-body{padding:18px;flex:2;display:flex;flex-direction:column;overflow:hidden;}
.section-title{font-size:15px;font-weight:700;color:var(--text);margin-bottom:10px;}
.hourly-forecast,.daily-forecast{display:flex;gap:10px;overflow-x:auto;padding:6px 0;}
.hourly-forecast::-webkit-scrollbar,.daily-forecast::-webkit-scrollbar{height:5px;}
.hourly-forecast::-webkit-scrollbar-thumb,.daily-forecast::-webkit-scrollbar-thumb{background:#667eea;border-radius:10px;}
.hour-card,.day-card{flex-shrink:0;text-align:center;padding:10px;border-radius:12px;transition:transform .3s;}
.hour-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;box-shadow:0 3px 10px rgba(0,0,0,0.1);}
.hour-card:hover{transform:translateY(-3px);}
.hour-time{font-size:11px;opacity:0.9;}
.hour-icon{font-size:22px;margin:4px 0;}
.hour-temp{font-size:15px;font-weight:700;}
.hour-rain{font-size:9px;opacity:0.8;}
.day-card{background:rgba(102,126,234,0.08);border:1px solid transparent;padding:12px;border-radius:12px;}
.day-card:hover{border-color:#667eea;transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,0.2);}
.day-name{font-weight:700;color:#667eea;font-size:12px;}
.day-icon{font-size:26px;margin:6px 0;}
.day-temps{display:flex;justify-content:center;gap:6px;font-size:13px;color:var(--text);}
.temp-max{font-weight:700;}
.temp-min{opacity:0.6;}
.day-rain{font-size:9px;opacity:0.8;margin-top:4px;}

/* Radio Widget - Modern */
#radioWidget{background:rgba(255,255,255,0.15);border-radius:16px;padding:16px;margin-top:12px;text-align:center;backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.1);}
#radioScreen{background:#000;color:#0f0;padding:10px;border-radius:8px;margin-bottom:12px;font-family:'Courier New',monospace;font-size:14px;letter-spacing:0.5px;}
.radio-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.radio-btn{background:rgba(255,255,255,0.2);color:#fff;border:none;padding:0;width:44px;height:44px;border-radius:50%;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;transition:all .2s;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.radio-btn:hover{background:rgba(255,255,255,0.3);transform:scale(1.05);}
#playPauseBtn{background:rgba(0,255,0,0.4);font-size:22px;}
#playPauseBtn.playing{background:rgba(255,100,100,0.5);}
.volume-controls{display:flex;justify-content:space-between;align-items:center;font-size:13px;}
.volume-btn{background:rgba(255,255,255,0.2);color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:600;transition:all .2s;}
.volume-btn:hover{background:rgba(255,255,255,0.3);}

/* Responsive */
@media (max-width: 768px) {
  .app{grid-template-columns:1fr;}
  .sidebar{position:fixed;top:0;left:-280px;width:280px;height:100%;z-index:99;transition:left .3s;box-shadow:2px 0 20px rgba(0,0,0,0.2);}
  .sidebar.open{left:0;}
  .main{margin:0;border-radius:0;}
}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar" id="sidebar">
    <div id="versionInfo">v1.9</div>
    <div class="brand">
      <div class="logo" id="userLogo">Y</div>
      <div>
        <h1 id="sidebarTitle">My Bookmarks</h1>
        <div id="sidebarSubtitleContainer" style="display:none;">
          <span id="sidebarSubtitle"></span>
          <button id="miniSignOutBtn">Çıkış</button>
        </div>
      </div>
    </div>
    <button class="btn" id="loginBtn">Google ile Giriş</button>
    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.2);margin:12px 0;">
    <button class="btn" id="homeBtn">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width:20px;height:20px;"><path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z"></path></svg>
      Ana Sayfa
    </button>
    <button class="btn" id="addCategoryBtn" style="display:none;">+ Kategori Ekle</button>
    <div class="categories" id="categories"></div>

    <!-- Radio Widget -->
    <div id="radioWidget">
      <div id="radioScreen">Radyo - İstasyon Seç</div>
      <div class="radio-controls">
        <button class="radio-btn" id="prevStationBtn">◀</button>
        <button class="radio-btn" id="playPauseBtn">▶</button>
        <button class="radio-btn" id="nextStationBtn">▶</button>
      </div>
      <div class="volume-controls">
        <button class="volume-btn" id="volumeDownBtn">−</button>
        <span id="volumeDisplay">50%</span>
        <button class="volume-btn" id="volumeUpBtn">+</button>
      </div>
    </div>
  </aside>

  <main class="main" id="main">
    <div class="header">
      <div class="header-title" id="pageTitle">Ana Sayfa</div>
    </div>
    <div id="contentArea"></div>
  </main>
</div>

<!-- Modals -->
<div class="modal" id="modal">
  <div class="modal-card">
    <h3 id="modalTitle">Yer İmi Ekle</h3>
    <div class="form-group"><label for="mTitle">Başlık</label><input id="mTitle" type="text"></div>
    <div class="form-group"><label for="mUrl">URL</label><input id="mUrl" type="text"></div>
    <div class="form-group"><label for="mCategory">Kategori</label><select id="mCategory"></select></div>
    <div class="form-group"><label for="mIcon">İkon (opsiyonel)</label><input id="mIcon" type="text"></div>
    <div class="switch"><input type="checkbox" id="mShowHome"><label for="mShowHome">Ana Sayfada Göster</label></div>
    <div class="modal-actions">
      <button class="btn" id="cancelModal">İptal</button>
      <button class="btn" id="saveModal">Kaydet</button>
    </div>
  </div>
</div>

<div class="modal" id="modalCategory">
  <div class="modal-card">
    <h3>Kategori Ekle</h3>
    <div class="form-group"><label for="cTitle">Kategori Adı</label><input id="cTitle" type="text"></div>
    <div class="modal-actions">
      <button class="btn" id="cancelCategory">İptal</button>
      <button class="btn" id="saveCategory">Kaydet</button>
    </div>
  </div>
</div>

<div class="modal" id="modalCategoryEdit">
  <div class="modal-card">
    <h3>Kategoriyi Düzenle</h3>
    <div class="form-group"><label for="ceTitle">Kategori Adı</label><input id="ceTitle" type="text"></div>
    <div class="form-group"><label for="ceOrder">Sıra (küçük = üstte)</label><input id="ceOrder" type="number" min="0"></div>
    <div class="modal-actions">
      <button class="btn" id="cancelCategoryEdit">İptal</button>
      <button class="btn" id="saveCategoryEdit">Kaydet</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBZ5oi1Vb-cNFQIk04rKMDwLJWVx06DfmI",
    authDomain: "my-g-bookmarks.firebaseapp.com",
    projectId: "my-g-bookmarks",
    storageBucket: "my-g-bookmarks.firebasestorage.app",
    messagingSenderId: "702837130313",
    appId: "1:702837130313:web:bb7e64d33a772ed3d1eb98",
    measurementId: "G-WZVPMS2XY4"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();

let BOOKMARKS = [], currentUser = null, currentView = 'home';
let editingState = { bookmarkId: null, categoryId: null };
const $ = (s) => document.querySelector(s);

// --- CORE ---
function sortCategories() { BOOKMARKS.sort((a, b) => (a.order ?? 999) - (b.order ?? 999)); }
async function handleDataChange() { await saveBookmarks(); renderApp(); }

// --- AUTH ---
onAuthStateChanged(auth, async user => {
    currentUser = user;
    if (user) {
        $('#sidebarTitle').textContent = user.displayName || 'Bookmarks';
        $('#sidebarSubtitle').textContent = user.email;
        $('#sidebarSubtitleContainer').style.display = 'flex';
        $('#userLogo').innerHTML = user.photoURL ? `<img src="${user.photoURL}" alt="User">` : (user.displayName || 'U').charAt(0);
        $('#loginBtn').style.display = 'none';
        $('#addCategoryBtn').style.display = 'block';
        const snap = await getDoc(doc(db, "bookmarks", user.uid));
        BOOKMARKS = (snap.exists() ? snap.data().categories : []) || [];
        BOOKMARKS.forEach((cat, i) => { cat.order ??= i; cat.items ??= []; });
        currentView = 'home';
        renderApp();
    } else {
        $('#sidebarTitle').textContent = 'My Bookmarks';
        $('#sidebarSubtitleContainer').style.display = 'none';
        $('#userLogo').textContent = 'Y';
        $('#loginBtn').style.display = 'block';
        $('#addCategoryBtn').style.display = 'none';
        BOOKMARKS = [];
        currentView = 'home';
        renderApp();
        $('#contentArea').innerHTML = "<div style='padding:20px;color:#666'>Lütfen giriş yapın.</div>";
    }
});

// --- SAVE ---
async function saveBookmarks() {
    if (!currentUser) return;
    const cleaned = BOOKMARKS.map(cat => ({
        ...cat,
        items: (cat.items || []).map(item => {
            const cleanedItem = {};
            for (const k in item) if (item[k] !== undefined) cleanedItem[k] = item[k];
            return cleanedItem;
        })
    }));
    await setDoc(doc(db, "bookmarks", currentUser.uid), { categories: cleaned });
}

// --- FAVICON ---
function createFaviconHTML(item, fallback) {
    if (item.icon) return `<img src="${item.icon}" alt="" onerror="this.parentElement.innerHTML='${fallback}'">`;
    const hostname = item.url ? new URL(item.url).hostname : '';
    if (!hostname) return fallback;
    const primary = `https://www.google.com/s2/favicons?domain=${hostname}&sz=64`;
    const fallbackSrc = `https://t1.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=http://${hostname}&size=64`;
    return `<img src="${primary}" alt="" onerror="this.onerror=null;this.src='${fallbackSrc}';this.onerror=null;this.parentElement.innerHTML='${fallback}';">`;
}

// --- RENDER ---
function renderCategories() {
    const el = $('#categories'); el.innerHTML = '';
    BOOKMARKS.forEach(cat => {
        const div = document.createElement('div');
        div.className = `category${cat.id === currentView ? ' active' : ''}`;
        div.dataset.id = cat.id;
        div.innerHTML = `<div class="cat-icon">${cat.title.charAt(0).toUpperCase()}</div><div class="cat-name">${cat.title}</div>`;
        el.appendChild(div);
    });
}

function renderHome() {
    $('#pageTitle').textContent = 'Ana Sayfa';
    const homeItems = BOOKMARKS.flatMap(c => (c.items || []).filter(i => i.showHome));
    const area = $('#contentArea'); area.innerHTML = '';

    const container = document.createElement('div');
    container.style.cssText = "display:flex;flex-direction:column;gap:28px;";

    // Favorites
    const favSec = document.createElement('div');
    favSec.innerHTML = `<h2 style="font-size:19px;font-weight:700;margin:0 0 12px;color:#333;">Favori Yer İmleri</h2>`;
    if (homeItems.length === 0) {
        favSec.innerHTML += `<div style="padding:20px;color:#777;font-style:italic;">Ana sayfada gösterilecek yer imi yok.</div>`;
    } else {
        const grid = document.createElement('div');
        grid.className = 'content-grid';
        homeItems.forEach(item => {
            const tile = document.createElement('a');
            tile.className = 'grid-tile';
            tile.href = item.url; tile.target = '_blank';
            tile.innerHTML = `${createFaviconHTML(item, item.title.charAt(0).toUpperCase())}<div class="title">${item.title}</div>`;
            grid.appendChild(tile);
        });
        favSec.appendChild(grid);
    }
    container.appendChild(favSec);

    // Weather
    const weatherHTML = `
    <div class="widget-container">
      <div class="widget-header">
        <div class="weather-animation" id="weatherAnimation"></div>
        <div class="district-selector">
          <select id="districtSelect">
            ${['Etimesgut','Çankaya','Keçiören','Mamak','Yenimahalle','Altındağ','Sincan','Pursaklar','Gölbaşı','Polatlı','Ankara Merkez'].map(d => `<option value="${d}">${d}</option>`).join('')}
          </select>
        </div>
        <div class="current-weather">
          <div>
            <div class="current-temp" id="currentTemp">--°</div>
            <div class="weather-desc" id="weatherDesc">Yükleniyor...</div>
          </div>
          <div class="weather-icon-main" id="mainIcon">Weather</div>
        </div>
        <div class="weather-details">
          <div class="detail-item"><span class="detail-icon">Humidity</span><span id="humidity">--%</span></div>
          <div class="detail-item"><span class="detail-icon">Wind</span><span id="wind">-- km/s</span></div>
          <div class="detail-item"><span class="detail-icon">Rain</span><span id="rainChance">--%</span></div>
        </div>
        <div class="api-notice">WeatherAPI.com</div>
      </div>
      <div class="widget-body">
        <div class="section-title">Saatlik</div>
        <div class="hourly-forecast" id="hourlyForecast"><div class="loading">Yükleniyor...</div></div>
        <div class="section-title">Günlük</div>
        <div class="daily-forecast" id="dailyForecast"><div class="loading">Yükleniyor...</div></div>
      </div>
    </div>`;
    const weatherSec = document.createElement('div');
    weatherSec.innerHTML = weatherHTML;
    container.appendChild(weatherSec);
    area.appendChild(container);

    setTimeout(initWeatherWidget, 100);
}

function renderCategory(catId) {
    const cat = BOOKMARKS.find(c => c.id === catId);
    if (!cat) { currentView = 'home'; renderApp(); return; }
    $('#pageTitle').textContent = cat.title;
    const area = $('#contentArea'); area.innerHTML = '';
    const items = cat.items || [];

    const grid = document.createElement('div');
    grid.className = 'content-grid';
    if (items.length === 0) {
        grid.innerHTML = `<div style="grid-column:1/-1;padding:30px;text-align:center;color:#777;font-style:italic;">Bu kategori boş.</div>`;
    } else {
        items.forEach(item => {
            const tile = document.createElement('a');
            tile.className = 'grid-tile';
            tile.href = item.url; tile.target = '_blank';
            tile.innerHTML = `${createFaviconHTML(item, item.title.charAt(0).toUpperCase())}<div class="title">${item.title}</div>`;
            grid.appendChild(tile);
        });
    }
    area.appendChild(grid);

    const addBtn = document.createElement('button');
    addBtn.textContent = '+ Yer İmi Ekle';
    addBtn.className = 'btn';
    addBtn.style.marginTop = '20px';
    area.appendChild(addBtn);
}

// --- RADIO ---
const stations = [
  { name: "Max FM", frequency: 95.8, url: "https://maxfm.radyotvonline.net/stream/164/" },
  { name: "Radyo ODTÜ", frequency: 103.1, url: "https://stream.radyoodtu.com.tr/canli" },
  { name: "Radyo İlef", frequency: 91.0, url: "http://radyo.cc.ankara.edu.tr:8089/stream/1" },
  { name: "Groove Salad", frequency: "Online", url: "https://ice5.somafm.com/groovesalad-128-mp3" },
  { name: "Space Station", frequency: "Online", url: "https://ice5.somafm.com/spacestation-128-mp3" },
  { name: "Lush", frequency: "Online", url: "https://ice5.somafm.com/lush-128-mp3" },
  { name: "Drone Zone", frequency: "Online", url: "https://ice5.somafm.com/dronezone-128-mp3" },
  { name: "Secret Agent", frequency: "Online", url: "https://ice5.somafm.com/secretagent-128-mp3" },
];
let currentStationIndex = 0, isPlaying = false, volume = 50;
const audio = new Audio();
audio.preload = "auto";

function updateRadioScreen() {
  const s = stations[currentStationIndex];
  $('#radioScreen').textContent = `${s.name} - ${s.frequency} MHz`;
}
function loadAndPlay() {
  const url = stations[currentStationIndex].url;
  audio.src = url;
  audio.load();
  updateRadioScreen();
  if (isPlaying) {
    audio.play().catch(e => console.log("Oynatma hatası:", e));
  }
}
function togglePlayPause() {
  isPlaying = !isPlaying;
  const btn = $('#playPauseBtn');
  btn.textContent = isPlaying ? 'Pause' : 'Play';
  btn.classList.toggle('playing', isPlaying);
  if (isPlaying) audio.play().catch(() => {});
  else audio.pause();
}
function changeStation(dir) {
  currentStationIndex = (currentStationIndex + dir + stations.length) % stations.length;
  loadAndPlay();
}
function changeVolume(delta) {
  volume = Math.max(0, Math.min(100, volume + delta));
  audio.volume = volume / 100;
  $('#volumeDisplay').textContent = `${volume}%`;
}

// Radio Events
$('#prevStationBtn').onclick = () => changeStation(-1);
$('#nextStationBtn').onclick = () => changeStation(1);
$('#playPauseBtn').onclick = togglePlayPause;
$('#volumeDownBtn').onclick = () => changeVolume(-10);
$('#volumeUpBtn').onclick = () => changeVolume(10);

// Init Radio
loadAndPlay();

// --- WEATHER ---
const API_KEY = 'cd6435a221fb4a71881124700252110';
const BASE_URL = 'https://api.weatherapi.com/v1';

function getWeatherIcon(code, isDay) {
  const icons = {1000: isDay?'Sun':'Moon',1003:'Partly Cloudy',1006:'Cloud',1009:'Cloud',1030:'Mist',1063:'Rain',1066:'Snow',1180:'Rain',1183:'Rain',1186:'Rain',1189:'Rain',1192:'Heavy Rain',1195:'Heavy Rain',1210:'Snow',1213:'Snow',1216:'Snow',1219:'Snow',1222:'Snow',1225:'Snow',1240:'Rain',1243:'Heavy Rain',1246:'Heavy Rain',1273:'Thunder',1276:'Thunder'};
  return icons[code] || 'Cloud';
}

function createWeatherAnimation(code, el) {
  el.innerHTML = '';
  if (code >= 1180 && code <= 1246) {
    for (let i = 0; i < 25; i++) { const d = document.createElement('div'); d.className='rain-drop'; d.style.left=Math.random()*100+'%'; d.style.animationDuration=(Math.random()*0.4+0.4)+'s'; d.style.animationDelay=Math.random()*2+'s'; el.appendChild(d); }
  } else if (code >= 1210 && code <= 1225) {
    for (let i = 0; i < 18; i++) { const s = document.createElement('div'); s.className='snow-flake'; s.style.left=Math.random()*100+'%'; s.style.animationDuration=(Math.random()*3+2)+'s'; s.style.animationDelay=Math.random()*2+'s'; el.appendChild(s); }
  } else if (code === 1000) {
    const sun = document.createElement('div'); sun.className='sun-rays'; sun.innerHTML='Sun'; el.appendChild(sun);
  }
}

async function fetchWeatherData(district) {
  try {
    const res = await fetch(`${BASE_URL}/forecast.json?key=${API_KEY}&q=${encodeURIComponent(district + ', Ankara, Turkey')}&days=3&aqi=yes&lang=tr`);
    if (!res.ok) throw new Error("API hatası");
    return await res.json();
  } catch (e) { console.error(e); return null; }
}

function updateWeather(data) {
  if (!data) return;
  const c = data.current, f = data.forecast.forecastday;
  $('#currentTemp').textContent = Math.round(c.temp_c) + '°';
  $('#weatherDesc').textContent = c.condition.text;
  $('#mainIcon').textContent = getWeatherIcon(c.condition.code, c.is_day);
  $('#humidity').textContent = c.humidity + '%';
  $('#wind').textContent = c.wind_kph.toFixed(1) + ' km/s';
  $('#rainChance').textContent = (f[0].day.daily_chance_of_rain || 0) + '%';
  createWeatherAnimation(c.condition.code, $('#weatherAnimation'));

  const allHours = f.flatMap(d => d.hour);
  const now = new Date().getHours();
  const next12 = allHours.slice(now, now + 12);
  $('#hourlyForecast').innerHTML = next12.map(h => {
    const t = new Date(h.time);
    return `<div class="hour-card"><div class="hour-time">${t.getHours()}:00</div><div class="hour-icon">${getWeatherIcon(h.condition.code, h.is_day)}</div><div class="hour-temp">${Math.round(h.temp_c)}°</div><div class="hour-rain">Rain ${h.chance_of_rain}%</div></div>`;
  }).join('');

  const days = ['Pazar','Pazartesi','Salı','Çarşamba','Perşembe','Cuma','Cumartesi'];
  $('#dailyForecast').innerHTML = f.map((d, i) => {
    const date = new Date(d.date), dayName = i===0?'Bugün':days[date.getDay()];
    return `<div class="day-card"><div class="day-name">${dayName}</div><div class="day-icon">${getWeatherIcon(d.day.condition.code,1)}</div><div class="day-temps"><span class="temp-max">${Math.round(d.day.maxtemp_c)}°</span><span class="temp-min">${Math.round(d.day.mintemp_c)}°</span></div><div class="day-rain">Rain ${d.day.daily_chance_of_rain}%</div></div>`;
  }).join('');
}

async function initWeatherWidget() {
  $('#hourlyForecast').innerHTML = '<div class="loading">Yükleniyor...</div>';
  $('#dailyForecast').innerHTML = '<div class="loading">Yükleniyor...</div>';
  const data = await fetchWeatherData('Etimesgut');
  if (data) updateWeather(data);
  $('#districtSelect').onchange = async e => {
    $('#hourlyForecast').innerHTML = '<div class="loading">Yükleniyor...</div>';
    $('#dailyForecast').innerHTML = '<div class="loading">Yükleniyor...</div>';
    const data = await fetchWeatherData(e.target.value);
    if (data) updateWeather(data);
  };
}

// --- MODALS & EVENTS ---
function openModalForAdd() {
  if (currentView === 'home') return alert("Lütfen bir kategori seçin.");
  editingState = { bookmarkId: null, categoryId: currentView };
  $('#modalTitle').textContent = "Yer İmi Ekle";
  $('#mTitle').value = $('#mUrl').value = $('#mIcon').value = '';
  $('#mShowHome').checked = false;
  populateCategorySelect(currentView);
  $('#modal').classList.add('active');
}

function openModalForEdit(bid, cid) {
  const { bookmark } = BOOKMARKS.flatMap(c => (c.items || []).map(i => ({bookmark:i, cat:c}))).find(x => x.bookmark.id === bid) || {};
  if (!bookmark) return;
  editingState = { bookmarkId: bid, categoryId: cid };
  $('#modalTitle').textContent = "Yer İmi Düzenle";
  $('#mTitle').value = bookmark.title;
  $('#mUrl').value = bookmark.url;
  $('#mIcon').value = bookmark.icon || '';
  $('#mShowHome').checked = !!bookmark.showHome;
  populateCategorySelect(cid);
  $('#modal').classList.add('active');
}

function populateCategorySelect(sel) {
  const s = $('#mCategory'); s.innerHTML = '';
  BOOKMARKS.forEach(c => s.innerHTML += `<option value="${c.id}" ${c.id===sel?'selected':''}>${c.title}</option>`);
}

$('#saveModal').onclick = async () => {
  const title = $('#mTitle').value.trim(), url = $('#mUrl').value.trim(), catId = $('#mCategory').value;
  if (!title || !url || !catId) return alert("Tüm alanlar zorunlu.");
  const fullUrl = url.match(/^https?:\/\//i) ? url : 'https://' + url;
  const data = { title, url: fullUrl, icon: $('#mIcon').value.trim()||undefined, showHome: $('#mShowHome').checked };
  const cat = BOOKMARKS.find(c => c.id === catId);
  if (editingState.bookmarkId) {
    const old = BOOKMARKS.flatMap(c => c.items.map(i => ({i, c}))).find(x => x.i.id === editingState.bookmarkId);
    if (old) {
      Object.assign(old.i, data);
      if (catId !== editingState.categoryId) {
        old.c.items = old.c.items.filter(i => i.id !== editingState.bookmarkId);
        cat.items.push(old.i);
      }
    }
  } else {
    cat.items.push({ id: 'b_'+Date.now(), ...data });
  }
  currentView = catId;
  $('#modal').classList.remove('active');
  await handleDataChange();
};

// Kategori Ekle/Düzenle
$('#addCategoryBtn').onclick = () => { $('#cTitle').value=''; $('#modalCategory').classList.add('active'); };
$('#saveCategory').onclick = () => {
  const t = $('#cTitle').value.trim();
  if (!t || BOOKMARKS.some(c => c.title.toLowerCase() === t.toLowerCase())) return alert("Geçersiz veya mevcut kategori.");
  const min = BOOKMARKS.length ? Math.min(...BOOKMARKS.map(c=>c.order??0)) : 0;
  BOOKMARKS.unshift({ id:'cat_'+Date.now(), title:t, order:min-1, items:[] });
  $('#modalCategory').classList.remove('active');
  handleDataChange();
};

$('#categories').onclick = e => {
  const cat = e.target.closest('.category');
  if (!cat) return;
  currentView = cat.dataset.id;
  renderApp();
};

$('#contentArea').onclick = e => {
  if (e.target.closest('button')?.textContent.includes('+ Yer İmi Ekle')) openModalForAdd();
};

$('#homeBtn').onclick = () => { currentView = 'home'; renderApp(); };
$('#loginBtn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
$('#miniSignOutBtn').onclick = () => signOut(auth);

document.addEventListener('keydown', e => { if (e.key==='Escape') document.querySelectorAll('.modal').forEach(m=>m.classList.remove('active')); });
['#cancelModal','#cancelCategory','#cancelCategoryEdit'].forEach(s=>$(s).onclick=()=>{$(s).closest('.modal').classList.remove('active');});

function renderApp() {
    sortCategories();
    renderCategories();
    currentView === 'home' ? renderHome() : renderCategory(currentView);
}
renderApp();
</script>
</body>
</html>
